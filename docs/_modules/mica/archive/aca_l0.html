
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mica.archive.aca_l0 &#8212; mica 4.32.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-astropy.css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">Ska!</span><span id="logotext2">mi</span><span id="logotext3">ca</span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://cxc.cfa.harvard.edu/mta/ASPECT/tool_doc">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">mica 4.32.0 documentation</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for mica.archive.aca_l0</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">import</span> <span class="nn">astropy.io.fits</span> <span class="k">as</span> <span class="nn">pyfits</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">tables</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">count</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">Ska.DBI</span>
<span class="kn">import</span> <span class="nn">Ska.arc5gl</span>
<span class="kn">from</span> <span class="nn">Chandra.Time</span> <span class="kn">import</span> <span class="n">DateTime</span>
<span class="kn">import</span> <span class="nn">Ska.File</span>
<span class="kn">from</span> <span class="nn">chandra_aca.aca_image</span> <span class="kn">import</span> <span class="n">ACAImage</span>
<span class="c1"># import kadi later in obsid_times</span>

<span class="kn">from</span> <span class="nn">mica.common</span> <span class="kn">import</span> <span class="n">MICA_ARCHIVE</span><span class="p">,</span> <span class="n">MissingDataError</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;aca0 fetch&#39;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">())</span>

<span class="c1"># borrowed from eng_archive</span>
<span class="n">ARCHFILES_HDR_COLS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;tstart&#39;</span><span class="p">,</span> <span class="s1">&#39;tstop&#39;</span><span class="p">,</span> <span class="s1">&#39;startmjf&#39;</span><span class="p">,</span> <span class="s1">&#39;startmnf&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;stopmjf&#39;</span><span class="p">,</span> <span class="s1">&#39;stopmnf&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;tlmver&#39;</span><span class="p">,</span> <span class="s1">&#39;ascdsver&#39;</span><span class="p">,</span> <span class="s1">&#39;revision&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;imgsize&#39;</span><span class="p">)</span>

<span class="n">FILETYPE</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="s1">&#39;L0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;instrum&#39;</span><span class="p">:</span> <span class="s1">&#39;PCAD&#39;</span><span class="p">,</span>
            <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;ACADATA&#39;</span><span class="p">,</span>
            <span class="s1">&#39;arc5gl_query&#39;</span><span class="p">:</span> <span class="s1">&#39;ACA0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fileglob&#39;</span><span class="p">:</span> <span class="s1">&#39;aca*fits*&#39;</span><span class="p">}</span>

<span class="n">ACA_DTYPE</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;TIME&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;QUALITY&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;i4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;MJF&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;i4&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;MNF&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;i4&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;END_INTEG_TIME&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f8&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;INTEG&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;GLBSTAT&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;COMMCNT&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;COMMPROG&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGFID1&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;IMGNUM1&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGFUNC1&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGSTAT&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;IMGROW0&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;i2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGCOL0&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;i2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGSCALE&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;i2&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;BGDAVG&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;i2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGFID2&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGNUM2&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;IMGFUNC2&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;BGDRMS&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;i2&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;TEMPCCD&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;TEMPHOUS&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;TEMPPRIM&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;TEMPSEC&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;BGDSTAT&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGFID3&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGNUM3&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;IMGFUNC3&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGFID4&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGNUM4&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;IMGFUNC4&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;IMGRAW&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">64</span><span class="p">,)),</span>
             <span class="p">(</span><span class="s1">&#39;HD3TLM62&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;HD3TLM63&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;HD3TLM64&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;HD3TLM65&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;HD3TLM66&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;HD3TLM67&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;HD3TLM72&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;HD3TLM73&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;HD3TLM74&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;HD3TLM75&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;HD3TLM76&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;HD3TLM77&#39;</span><span class="p">,</span> <span class="s1">&#39;|u1&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;IMGSIZE&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;i4&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;FILENAME&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;U128&#39;</span><span class="p">))</span>

<span class="n">ACA_DTYPE_8x8</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span> <span class="k">if</span> <span class="n">dt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;IMGRAW&#39;</span> <span class="k">else</span> <span class="n">dt</span>
                      <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">ACA_DTYPE</span><span class="p">)</span>

<span class="n">ACA_DTYPE_NAMES</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ACA_DTYPE</span><span class="p">])</span>

<span class="n">CONFIG</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data_root</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MICA_ARCHIVE</span><span class="p">,</span> <span class="s1">&#39;aca0&#39;</span><span class="p">),</span>
              <span class="n">temp_root</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MICA_ARCHIVE</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">),</span>
              <span class="n">days_at_once</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span>
              <span class="n">sql_def</span><span class="o">=</span><span class="s1">&#39;archfiles_aca_l0_def.sql&#39;</span><span class="p">,</span>
              <span class="n">cda_table</span><span class="o">=</span><span class="s1">&#39;cda_aca0.h5&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_options</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Fetch aca level 0 products and make a file archive&quot;</span><span class="p">)</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="o">**</span><span class="n">defaults</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--data-root&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;parent directory for all data&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--temp-root&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;parent temp directory&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--start&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;start date for retrieve &quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;(defaults to max date of archived files)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--stop&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;stop date for retrieve &quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;(defaults to now)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--days-at-once&quot;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;if over this number, &quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;bin to chunks of this number of days&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--cda-table&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;file name for h5 list from Chandra Archive&quot;</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">opt</span>


<div class="viewcode-block" id="get_slot_data"><a class="viewcode-back" href="../../../api.html#mica.archive.aca_l0.get_slot_data">[docs]</a><span class="k">def</span> <span class="nf">get_slot_data</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">imgsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">centered_8x8</span><span class="o">=</span><span class="kc">False</span>
                  <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For a the given parameters, retrieve telemetry and construct a</span>
<span class="sd">    masked array of the MSIDs available in that telemetry.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import aca_l0</span>
<span class="sd">      &gt;&gt;&gt; slot_data = aca_l0.get_slot_data(&#39;2012:001&#39;, &#39;2012:002&#39;, slot=7)</span>
<span class="sd">      &gt;&gt;&gt; temp_ccd_8x8 = aca_l0.get_slot_data(&#39;2005:001&#39;, &#39;2005:010&#39;,</span>
<span class="sd">      ...                                     slot=6, imgsize=[8],</span>
<span class="sd">      ...                                     columns=[&#39;TIME&#39;, &#39;TEMPCCD&#39;])</span>

<span class="sd">    :param start: start time of requested interval</span>
<span class="sd">    :param stop: stop time of requested interval</span>
<span class="sd">    :param slot: slot number integer (in the range 0 -&gt; 7)</span>
<span class="sd">    :param imgsize: list of integers of desired image sizes</span>
<span class="sd">                    (defaults to all -&gt; [4, 6, 8])</span>
<span class="sd">    :param db: handle to archive lookup table</span>
<span class="sd">    :param data_root: parent directory that contains archfiles.db3</span>
<span class="sd">                      (for use when db handle not available)</span>
<span class="sd">    :param columns: list of desired columns in the ACA0 telemetry</span>
<span class="sd">                    (defaults to all in 8x8 telemetry)</span>
<span class="sd">    :param centered_8x8: boolean flag to reshape the IMGRAW field to (-1, 8, 8)</span>
<span class="sd">                         (defaults to False)</span>
<span class="sd">    :returns: data structure for slot</span>
<span class="sd">    :rtype: numpy masked recarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_root</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;data_root&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="n">ACA_DTYPE_NAMES</span>
    <span class="k">if</span> <span class="n">imgsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">imgsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dbfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_root</span><span class="p">,</span> <span class="s1">&#39;archfiles.db3&#39;</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dbi</span><span class="o">=</span><span class="s1">&#39;sqlite&#39;</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="n">dbfile</span><span class="p">)</span>

    <span class="n">data_files</span> <span class="o">=</span> <span class="n">_get_file_records</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">slots</span><span class="o">=</span><span class="p">[</span><span class="n">slot</span><span class="p">],</span>
                                    <span class="n">imgsize</span><span class="o">=</span><span class="n">imgsize</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
                                    <span class="n">data_root</span><span class="o">=</span><span class="n">data_root</span><span class="p">)</span>
    <span class="n">aca_dtype</span> <span class="o">=</span> <span class="n">ACA_DTYPE_8x8</span> <span class="k">if</span> <span class="n">centered_8x8</span> <span class="k">else</span> <span class="n">ACA_DTYPE</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">aca_dtype</span> <span class="k">if</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_files</span><span class="p">):</span>
        <span class="c1"># return an empty masked array</span>
        <span class="k">return</span> <span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_files</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">])</span>
    <span class="n">zero_row</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">zero_row</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="n">all_rows</span> <span class="o">=</span> <span class="n">zero_row</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="n">rowcount</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">data_files</span><span class="p">:</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_root</span><span class="p">,</span>
                          <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]),</span>
                          <span class="s2">&quot;</span><span class="si">{0:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;doy&#39;</span><span class="p">]),</span>
                          <span class="n">f</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">])</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="n">chunk</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
        <span class="n">idx0</span><span class="p">,</span> <span class="n">idx1</span> <span class="o">=</span> <span class="n">rowcount</span><span class="p">,</span> <span class="p">(</span><span class="n">rowcount</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))</span>
        <span class="n">f_imgsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;IMGRAW&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">all_rows</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fname</span> <span class="o">==</span> <span class="s1">&#39;IMGRAW&#39;</span> <span class="ow">or</span> <span class="n">fname</span> <span class="o">==</span> <span class="s1">&#39;IMGSIZE&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">chunk</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="n">all_rows</span><span class="p">[</span><span class="n">fname</span><span class="p">][</span><span class="n">idx0</span><span class="p">:</span> <span class="n">idx1</span><span class="p">]</span> \
                    <span class="o">=</span> <span class="n">chunk</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;IMGSIZE&#39;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">all_rows</span><span class="p">[</span><span class="s1">&#39;IMGSIZE&#39;</span><span class="p">][</span><span class="n">idx0</span><span class="p">:</span> <span class="n">idx1</span><span class="p">]</span> <span class="o">=</span> <span class="n">f_imgsize</span>
        <span class="k">if</span> <span class="s1">&#39;FILENAME&#39;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">all_rows</span><span class="p">[</span><span class="s1">&#39;FILENAME&#39;</span><span class="p">][</span><span class="n">idx0</span><span class="p">:</span> <span class="n">idx1</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;IMGRAW&#39;</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">centered_8x8</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f_imgsize</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="n">all_rows</span><span class="p">[</span><span class="s1">&#39;IMGRAW&#39;</span><span class="p">][</span><span class="n">idx0</span><span class="p">:</span> <span class="n">idx1</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;IMGRAW&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">f_imgsize</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="n">all_rows</span><span class="p">[</span><span class="s1">&#39;IMGRAW&#39;</span><span class="p">][</span><span class="n">idx0</span><span class="p">:</span> <span class="n">idx1</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="o">-</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="o">-</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;IMGRAW&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_rows</span><span class="p">[</span><span class="s1">&#39;IMGRAW&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)[</span>
                    <span class="n">idx0</span><span class="p">:</span> <span class="n">idx1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">f_imgsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">f_imgsize</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">chunk</span><span class="p">[</span><span class="s1">&#39;IMGRAW&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">),</span>
                                                  <span class="n">f_imgsize</span><span class="p">,</span> <span class="n">f_imgsize</span><span class="p">))</span>
        <span class="n">rowcount</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

    <span class="c1"># just include the rows in the requested time range in the returned data</span>
    <span class="n">oktime</span> <span class="o">=</span> <span class="p">((</span><span class="n">all_rows</span><span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span><span class="p">)</span>
               <span class="o">&amp;</span> <span class="p">(</span><span class="n">all_rows</span><span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">all_rows</span><span class="p">[</span><span class="n">oktime</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_l0_images"><a class="viewcode-back" href="../../../api.html#mica.archive.aca_l0.get_l0_images">[docs]</a><span class="k">def</span> <span class="nf">get_l0_images</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">imgsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get ACA L0 images for the given  ``start`` and ``stop`` times and</span>
<span class="sd">    the given ``slot``.  Optionally filter on image size via ``imgsize``</span>
<span class="sd">    or change the default image metadata via ``columns``.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import aca_l0</span>
<span class="sd">      &gt;&gt;&gt; imgs = aca_l0.get_l0_images(&#39;2012:001&#39;, &#39;2012:002&#39;, slot=7)</span>
<span class="sd">      &gt;&gt;&gt; imgs = aca_l0.get_l0_images(&#39;2005:001&#39;, &#39;2005:002&#39;, slot=6, imgsize=[8])</span>

<span class="sd">    The default columns are:</span>
<span class="sd">    [&#39;TIME&#39;, &#39;IMGROW0&#39;, &#39;IMGCOL0&#39;, &#39;BGDAVG&#39;, &#39;IMGSTAT&#39;, &#39;IMGFUNC1&#39;, &#39;IMGSIZE&#39;, &#39;IMGSCALE&#39;, &#39;INTEG&#39;]</span>

<span class="sd">    The image pixel values are given in units of DN.  One can convert to e-/sec</span>
<span class="sd">    by multiplying by (5 / INTEG).</span>

<span class="sd">    :param start: start time of requested interval</span>
<span class="sd">    :param stop: stop time of requested interval</span>
<span class="sd">    :param slot: slot number integer (in the range 0 -&gt; 7)</span>
<span class="sd">    :param imgsize: list of integers of desired image sizes (default=[4, 6, 8])</span>
<span class="sd">    :param columns: image meta-data columns</span>

<span class="sd">    :returns: list of ACAImage objects</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">,</span> <span class="s1">&#39;BGDAVG&#39;</span><span class="p">,</span> <span class="s1">&#39;IMGSTAT&#39;</span><span class="p">,</span> <span class="s1">&#39;IMGFUNC1&#39;</span><span class="p">,</span> <span class="s1">&#39;IMGSIZE&#39;</span><span class="p">,</span> <span class="s1">&#39;IMGSCALE&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEG&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;IMGROW0&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;IMGROW0&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;IMGCOL0&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;IMGCOL0&#39;</span><span class="p">)</span>

    <span class="n">slot_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">columns</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;QUALITY&#39;</span><span class="p">,</span> <span class="s1">&#39;IMGRAW&#39;</span><span class="p">,</span> <span class="s1">&#39;IMGSIZE&#39;</span><span class="p">]))</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">get_slot_data</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">imgsize</span><span class="o">=</span><span class="n">imgsize</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">slot_columns</span><span class="p">)</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;QUALITY&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ok</span><span class="p">)):</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">ok</span><span class="p">]</span>

    <span class="c1"># Convert temperatures from K to degC</span>
    <span class="k">for</span> <span class="n">temp</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;TEMPCCD&#39;</span><span class="p">,</span> <span class="s1">&#39;TEMPHOUS&#39;</span><span class="p">,</span> <span class="s1">&#39;TEMPPRIM&#39;</span><span class="p">,</span> <span class="s1">&#39;TEMPSEC&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">temp</span> <span class="ow">in</span> <span class="n">dat</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">273.15</span>

    <span class="c1"># Masked array col access ~100 times slower than ndarray so convert</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="o">-</span><span class="mi">9999</span><span class="p">)</span>

    <span class="n">imgs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">imgsizes</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;IMGSIZE&#39;</span><span class="p">]</span>
    <span class="n">imgraws</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;IMGRAW&#39;</span><span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">dat</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dat</span><span class="p">):</span>
        <span class="n">imgraw</span> <span class="o">=</span> <span class="n">imgraws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">sz</span> <span class="o">=</span> <span class="n">imgsizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sz</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">imgraw</span> <span class="o">=</span> <span class="n">imgraw</span><span class="p">[:</span><span class="n">sz</span><span class="p">,</span> <span class="p">:</span><span class="n">sz</span><span class="p">]</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">9999</span><span class="p">}</span>
        <span class="n">imgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ACAImage</span><span class="p">(</span><span class="n">imgraw</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">imgs</span></div>


<span class="k">class</span> <span class="nc">MSID</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msid</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tstart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datestart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tstart</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datestop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tstop</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slot</span> <span class="o">=</span> <span class="n">slot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_msid</span><span class="p">(</span><span class="n">msid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_data</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_check_msid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_msid</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">req_msid</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ACA_DTYPE_NAMES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">msid</span> <span class="o">=</span> <span class="n">req_msid</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MissingDataError</span><span class="p">(</span><span class="s2">&quot;msid </span><span class="si">%s</span><span class="s2"> not found&quot;</span> <span class="o">%</span> <span class="n">req_msid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">slot_data</span> <span class="o">=</span> <span class="n">get_slot_data</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tstart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span> <span class="n">imgsize</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msid</span><span class="o">.</span><span class="n">upper</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vals</span> <span class="o">=</span> <span class="n">slot_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">msid</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times</span> <span class="o">=</span> <span class="n">slot_data</span><span class="p">[</span><span class="s1">&#39;TIME&#39;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">MSIDset</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msids</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MSIDset</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tstart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datestart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tstart</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datestop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tstop</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
        <span class="k">for</span> <span class="n">msid</span> <span class="ow">in</span> <span class="n">msids</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">msid</span><span class="p">]</span> <span class="o">=</span> <span class="n">MSID</span><span class="p">(</span><span class="n">msid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstart</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tstop</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">obsid_times</span><span class="p">(</span><span class="n">obsid</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">kadi</span> <span class="kn">import</span> <span class="n">events</span>  <span class="c1"># Kadi is a big import so defer</span>
    <span class="n">dwells</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">dwells</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="n">obsid</span><span class="p">)</span>
    <span class="n">n_dwells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dwells</span><span class="p">)</span>
    <span class="n">tstart</span> <span class="o">=</span> <span class="n">dwells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tstart</span>
    <span class="n">tstop</span> <span class="o">=</span> <span class="n">dwells</span><span class="p">[</span><span class="n">n_dwells</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tstop</span>

    <span class="k">return</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span>


<div class="viewcode-block" id="get_files"><a class="viewcode-back" href="../../../api.html#mica.archive.aca_l0.get_files">[docs]</a><span class="k">def</span> <span class="nf">get_files</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">slots</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imgsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_root</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve list of files from ACA0 archive lookup table that</span>
<span class="sd">    match arguments.  The database query returns files with</span>

<span class="sd">      tstart &lt; stop</span>
<span class="sd">      and</span>
<span class="sd">      tstop &gt; start</span>

<span class="sd">    which returns all files that contain any part of the interval</span>
<span class="sd">    between start and stop.  If the obsid argument is provided, the</span>
<span class="sd">    archived obspar tstart/tstop (sybase aca.obspar table) are used.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import aca_l0</span>
<span class="sd">      &gt;&gt;&gt; obsid_files = aca_l0.get_files(obsid=5438)</span>
<span class="sd">      &gt;&gt;&gt; time_files = aca_l0.get_files(start=&#39;2012:001&#39;, stop=&#39;2012:002&#39;)</span>
<span class="sd">      &gt;&gt;&gt; time_8x8 = aca_l0.get_files(start=&#39;2011:001&#39;, stop=&#39;2011:010&#39;,</span>
<span class="sd">      ...                             imgsize=[8])</span>

<span class="sd">    :param obsid: obsid</span>
<span class="sd">    :param start: start time of requested interval</span>
<span class="sd">    :param stop: stop time of requested interval</span>
<span class="sd">    :param slots: list of integers of desired image slots to retrieve</span>
<span class="sd">                   (defaults to all -&gt; [0, 1, 2, 3, 4, 5, 6, 7, 8])</span>
<span class="sd">    :param imgsize: list of integers of desired image sizes</span>
<span class="sd">                    (defaults to all -&gt; [4, 6, 8])</span>
<span class="sd">    :param db: handle to archive lookup table</span>
<span class="sd">    :param data_root: parent directory of Ska aca l0 archive</span>

<span class="sd">    :returns: interval files</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">slots</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">slots</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">data_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_root</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;data_root&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">imgsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">imgsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dbfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_root</span><span class="p">,</span> <span class="s1">&#39;archfiles.db3&#39;</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dbi</span><span class="o">=</span><span class="s1">&#39;sqlite&#39;</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="n">dbfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obsid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Must supply either obsid or start and stop&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">obsid_times</span><span class="p">(</span><span class="n">obsid</span><span class="p">)</span>

    <span class="n">file_records</span> <span class="o">=</span> <span class="n">_get_file_records</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span>
                                     <span class="n">slots</span><span class="o">=</span><span class="n">slots</span><span class="p">,</span> <span class="n">imgsize</span><span class="o">=</span><span class="n">imgsize</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
                                     <span class="n">data_root</span><span class="o">=</span><span class="n">data_root</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_root</span><span class="p">,</span>
                          <span class="s2">&quot;</span><span class="si">%04d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span>
                          <span class="s2">&quot;</span><span class="si">%03d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;doy&#39;</span><span class="p">],</span>
                          <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]))</span>
             <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_records</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">files</span></div>


<span class="k">def</span> <span class="nf">_get_file_records</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">slots</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">imgsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_root</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve list of files from ACA0 archive lookup table that</span>
<span class="sd">    match arguments.  The database query returns files with</span>

<span class="sd">      tstart &lt; stop</span>
<span class="sd">      and</span>
<span class="sd">      tstop &gt; start</span>

<span class="sd">    which returns all files that contain any part of the interval</span>
<span class="sd">    between start and stop.</span>

<span class="sd">    :param start: start time of requested interval</span>
<span class="sd">    :param stop: stop time of requested interval</span>
<span class="sd">                 (default of None will get DateTime(None) which is</span>
<span class="sd">                 equivalent to &#39;now&#39;)</span>
<span class="sd">    :param slots: list of integers of desired image slots to retrieve</span>
<span class="sd">                   (defaults to all -&gt; [0, 1, 2, 3, 4, 5, 6, 7, 8])</span>
<span class="sd">    :param imgsize: list of integers of desired image sizes</span>
<span class="sd">                    (defaults to all -&gt; [4, 6, 8])</span>
<span class="sd">    :param db: handle to archive lookup table</span>
<span class="sd">    :param data_root: parent directory of Ska aca l0 archive</span>

<span class="sd">    :returns: interval files</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">slots</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">slots</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">data_root</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_root</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="p">[</span><span class="s1">&#39;data_root&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">imgsize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">imgsize</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dbfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_root</span><span class="p">,</span> <span class="s1">&#39;archfiles.db3&#39;</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dbi</span><span class="o">=</span><span class="s1">&#39;sqlite&#39;</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="n">dbfile</span><span class="p">)</span>

    <span class="n">tstart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
    <span class="n">tstop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">secs</span>
    <span class="n">imgsize_str</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">imgsize</span><span class="p">])</span>
    <span class="n">slot_str</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">slots</span><span class="p">])</span>
    <span class="c1"># a composite index isn&#39;t as fast as just doing a padded search on one</span>
    <span class="c1"># index first (tstart).  This gets extra files to make sure we don&#39;t</span>
    <span class="c1"># miss the case where tstart is in the middle of an interval, but</span>
    <span class="c1"># drastically reduces the size of the bsearch on the tstop index</span>
    <span class="n">tstart_pad</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">86400</span>
    <span class="n">db_query</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;SELECT * FROM archfiles &#39;</span>
                <span class="s1">&#39;WHERE tstart &gt;= </span><span class="si">%f</span><span class="s1"> - </span><span class="si">%f</span><span class="s1"> &#39;</span>
                <span class="s1">&#39;AND tstart &lt; </span><span class="si">%f</span><span class="s1"> &#39;</span>
                <span class="s1">&#39;AND tstop &gt; </span><span class="si">%f</span><span class="s1"> &#39;</span>
                <span class="s1">&#39;AND slot in (</span><span class="si">%s</span><span class="s1">) &#39;</span>
                <span class="s1">&#39;AND imgsize in (</span><span class="si">%s</span><span class="s1">) &#39;</span>
                <span class="s1">&#39;order by filetime asc &#39;</span>
                <span class="o">%</span> <span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstart_pad</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">slot_str</span><span class="p">,</span> <span class="n">imgsize_str</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">Ska</span><span class="o">.</span><span class="n">DBI</span><span class="o">.</span><span class="n">DBI</span><span class="p">(</span><span class="o">**</span><span class="n">db</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">fetchall</span><span class="p">(</span><span class="n">db_query</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">files</span>


<span class="k">class</span> <span class="nc">Updater</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">data_root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">temp_root</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">days_at_once</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sql_def</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cda_table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">filetype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="p">):</span>
        <span class="k">for</span> <span class="n">init_opt</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;data_root&#39;</span><span class="p">,</span> <span class="s1">&#39;temp_root&#39;</span><span class="p">,</span> <span class="s1">&#39;days_at_once&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;sql_def&#39;</span><span class="p">,</span> <span class="s1">&#39;cda_table&#39;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_opt</span><span class="p">,</span> <span class="nb">vars</span><span class="p">()[</span><span class="n">init_opt</span><span class="p">]</span> <span class="ow">or</span> <span class="n">CONFIG</span><span class="p">[</span><span class="n">init_opt</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_root</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_root</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span> <span class="o">=</span> <span class="n">filetype</span> <span class="ow">or</span> <span class="n">FILETYPE</span>
        <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dbfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_root</span><span class="p">,</span> <span class="s1">&#39;archfiles.db3&#39;</span><span class="p">)</span>
            <span class="n">db</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dbi</span><span class="o">=</span><span class="s1">&#39;sqlite&#39;</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="n">dbfile</span><span class="p">,</span> <span class="n">autocommit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">stop</span>

<span class="c1">#def _rebuild_database(db=None, db_file=None,</span>
<span class="c1">#                      data_root=config[&#39;data_root&#39;],</span>
<span class="c1">#                      sql_def=config[&#39;sql_def&#39;]):</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    Utility routine to rebuild the file lookup database using the</span>
<span class="c1">#    package defaults and the files in the archive.</span>
<span class="c1">#    &quot;&quot;&quot;</span>
<span class="c1">#    if db is None and db_file is None:</span>
<span class="c1">#        raise ValueError</span>
<span class="c1">#    if db is None and db_file is not None:</span>
<span class="c1">#        logger.info(&quot;creating archfiles db from %s&quot;</span>
<span class="c1">#                    % sql_def)</span>
<span class="c1">#        db_sql = os.path.join(os.environ[&#39;SKA_DATA&#39;],</span>
<span class="c1">#                              &#39;mica&#39;, sql_def)</span>
<span class="c1">#        db_init_cmds = file(db_sql).read()</span>
<span class="c1">#        db = Ska.DBI.DBI(dbi=&#39;sqlite&#39;, server=db_file,</span>
<span class="c1">#                         autocommit=False)</span>
<span class="c1">#        db.execute(db_init_cmds, commit=True)</span>
<span class="c1">#    year_dirs = sorted(glob(</span>
<span class="c1">#            os.path.join(data_root, &#39;[12][0-9][0-9][0-9]&#39;)))</span>
<span class="c1">#    for ydir in year_dirs:</span>
<span class="c1">#        day_dirs = sorted(glob(</span>
<span class="c1">#                os.path.join(ydir, &#39;[0-3][0-9][0-9]&#39;)))</span>
<span class="c1">#        for ddir in day_dirs:</span>
<span class="c1">#            archfiles = sorted(glob(</span>
<span class="c1">#                    os.path.join(ddir, &#39;*_img0*&#39;)))</span>
<span class="c1">#            db.execute(&quot;begin transaction&quot;)</span>
<span class="c1">#            for i, f in enumerate(archfiles):</span>
<span class="c1">#                arch_info = read_archfile(i, f, archfiles, db)</span>
<span class="c1">#                if arch_info:</span>
<span class="c1">#                    db.insert(arch_info, &#39;archfiles&#39;)</span>
<span class="c1">#            db.commit()</span>

    <span class="k">def</span> <span class="nf">_get_missing_archive_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">only_new</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">ingested_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_arc_ingested_files</span><span class="p">()</span>
        <span class="n">startdate</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Checking for missing files from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="n">startdate</span><span class="p">)</span>
        <span class="c1"># find the index in the cda archive list that matches</span>
        <span class="c1"># the first entry with the &quot;start&quot; date</span>
        <span class="k">for</span> <span class="n">idate</span><span class="p">,</span> <span class="n">backcnt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ingested_files</span><span class="p">[</span><span class="s1">&#39;ingest_date&#39;</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                   <span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">idate</span> <span class="o">&lt;</span> <span class="n">startdate</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="n">last_ok_date</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># for the entries after the start date, see if we have the</span>
        <span class="c1"># file or a later version</span>
        <span class="k">with</span> <span class="n">Ska</span><span class="o">.</span><span class="n">DBI</span><span class="o">.</span><span class="n">DBI</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">file</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ingested_files</span><span class="p">[</span><span class="o">-</span><span class="n">backcnt</span><span class="p">:],</span> <span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
                <span class="n">db_match</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">fetchall</span><span class="p">(</span>
                    <span class="s2">&quot;select * from archfiles where &quot;</span>
                    <span class="o">+</span> <span class="s2">&quot;filename = &#39;</span><span class="si">%s</span><span class="s2">&#39; or filename = &#39;</span><span class="si">%s</span><span class="s2">.gz&#39;&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">db_match</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">file_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s1">&#39;acaf(\d+)N(\d</span><span class="si">{3}</span><span class="s1">)_(\d)_img0.fits(\.gz)?&#39;</span><span class="p">,</span>
                    <span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">file_re</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">slot</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file_re</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                <span class="n">filetime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file_re</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file_re</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                <span class="c1"># if there is an old file and we&#39;re just looking for new ones</span>
                <span class="n">range_match</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">fetchall</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;SELECT * from archfiles</span>
<span class="sd">                       WHERE filetime = %(filetime)d</span>
<span class="sd">                       and slot = %(slot)d&quot;&quot;&quot;</span> <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">filetime</span><span class="o">=</span><span class="n">filetime</span><span class="p">,</span> <span class="n">slot</span><span class="o">=</span><span class="n">slot</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">range_match</span> <span class="ow">and</span> <span class="n">only_new</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># if there is a newer file there already</span>
                <span class="n">version_match</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">fetchall</span><span class="p">(</span>
                    <span class="sd">&quot;&quot;&quot;SELECT * from archfiles</span>
<span class="sd">                       WHERE filetime = %(filetime)d</span>
<span class="sd">                       and slot = %(slot)d</span>
<span class="sd">                       and revision &gt;= %(version)d&quot;&quot;&quot;</span>
                    <span class="o">%</span> <span class="nb">dict</span><span class="p">(</span><span class="n">slot</span><span class="o">=</span><span class="n">slot</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span> <span class="n">filetime</span><span class="o">=</span><span class="n">filetime</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">version_match</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># and if made it this far add the file to the list</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
                <span class="c1"># and update the date through which data is complete to</span>
                <span class="c1"># the time of the previous file ingest</span>
                <span class="k">if</span> <span class="n">last_ok_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">last_ok_date</span> <span class="o">=</span> \
                        <span class="n">ingested_files</span><span class="p">[</span><span class="s1">&#39;ingest_date&#39;</span><span class="p">][</span><span class="o">-</span><span class="n">backcnt</span><span class="p">:][</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">last_ok_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">last_ok_date</span> <span class="o">=</span> <span class="n">ingested_files</span><span class="p">[</span><span class="s1">&#39;ingest_date&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">missing</span><span class="p">,</span> <span class="n">last_ok_date</span>

    <span class="k">def</span> <span class="nf">_get_arc_ingested_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">table_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cda_table</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tables</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">table_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5f</span><span class="p">:</span>
            <span class="n">tbl</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
            <span class="n">arc_files</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[:]</span>
        <span class="k">return</span> <span class="n">Table</span><span class="p">(</span><span class="n">arc_files</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_archive_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update FITS file archive with arc5gl and ingest files into file archive</span>

<span class="sd">        :param filetype: a dictionary (or dictionary-like) object with keys for</span>
<span class="sd">                         &#39;level&#39;, &#39;instrum&#39;, &#39;content&#39;, &#39;arc5gl_query&#39;</span>
<span class="sd">                         and &#39;fileglob&#39; for arc5gl.  For ACA0:</span>
<span class="sd">                         {&#39;level&#39;: &#39;L0&#39;, &#39;instrum&#39;: &#39;PCAD&#39;,</span>
<span class="sd">                         &#39;content&#39;: &#39;ACADATA&#39;, &#39;arc5gl_query&#39;: &#39;ACA0&#39;,</span>
<span class="sd">                         &#39;fileglob&#39;: &#39;aca*fits*&#39;}</span>
<span class="sd">        :param start: start of interval to retrieve (Chandra.Time compatible)</span>
<span class="sd">        :param stop: end of interval to retrieve (Chandra.Time compatible)</span>

<span class="sd">        :returns: retrieved file names</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">filetype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span>
        <span class="c1"># Retrieve CXC archive files in a temp directory with arc5gl</span>
        <span class="n">arc5</span> <span class="o">=</span> <span class="n">Ska</span><span class="o">.</span><span class="n">arc5gl</span><span class="o">.</span><span class="n">Arc5gl</span><span class="p">()</span>
        <span class="n">arc5</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;tstart=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="n">arc5</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;tstop=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="n">arc5</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;get </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filetype</span><span class="p">[</span><span class="s1">&#39;arc5gl_query&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">filetype</span><span class="p">[</span><span class="s1">&#39;fileglob&#39;</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_read_archfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">archfiles</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read FITS filename ``f`` with index ``i`` (position within list of</span>
<span class="sd">        filenames) and get dictionary of values to store in file lookup</span>
<span class="sd">        database.  These values include all header items in</span>
<span class="sd">        ``ARCHFILES_HDR_COLS`` plus the header checksum, the image slot</span>
<span class="sd">        as determined by the filename, the imagesize as determined</span>
<span class="sd">        by IMGRAW, the year, day-of-year, and number of data rows in the file.</span>

<span class="sd">        :param i: index of file f within list of files archfiles</span>
<span class="sd">        :param f: filename</span>
<span class="sd">        :param archfiles: list of filenames for this batch</span>
<span class="sd">        :param db: database handle for file lookup database (Ska.DBI handle)</span>

<span class="sd">        :returns: info for a file.</span>
<span class="sd">        :rtype: dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check if filename is already in file lookup table</span>
        <span class="c1"># If so then delete temporary file and abort further processing.</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">Ska</span><span class="o">.</span><span class="n">DBI</span><span class="o">.</span><span class="n">DBI</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">fetchall</span><span class="p">(</span><span class="s1">&#39;SELECT filename FROM archfiles WHERE filename=?&#39;</span><span class="p">,</span>
                           <span class="p">(</span><span class="n">filename</span><span class="p">,)):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> already in archfiles - unlinking and skipping&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Reading (</span><span class="si">%d</span><span class="s1"> / </span><span class="si">%d</span><span class="s1">) </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">archfiles</span><span class="p">),</span> <span class="n">filename</span><span class="p">))</span>
        <span class="n">hdus</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">hdus</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Accumlate relevant info about archfile that will be ingested</span>
        <span class="c1"># (this is borrowed from eng-archive but is set to archive to a</span>
        <span class="c1"># database table instead of an h5 table in this version)</span>
        <span class="n">archfiles_row</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
                             <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ARCHFILES_HDR_COLS</span><span class="p">)</span>
        <span class="n">archfiles_row</span><span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;checksum&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">hdu</span><span class="o">.</span><span class="n">_checksum</span>
        <span class="n">imgsize</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;IMGRAW&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">archfiles_row</span><span class="p">[</span><span class="s1">&#39;imgsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">imgsize</span><span class="p">)</span>
        <span class="n">archfiles_row</span><span class="p">[</span><span class="s1">&#39;slot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="sa">r</span><span class="s1">&#39;acaf\d+N\d</span><span class="si">{3}</span><span class="s1">_(\d)_img0.fits(\.gz)?&#39;</span><span class="p">,</span>
                <span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">archfiles_row</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">archfiles_row</span><span class="p">[</span><span class="s1">&#39;filetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)&#39;</span><span class="p">,</span> <span class="n">archfiles_row</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">filedate</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">archfiles_row</span><span class="p">[</span><span class="s1">&#39;filetime&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">date</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">doy</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span>
                     <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d\d\d\d):(\d\d\d)&#39;</span><span class="p">,</span> <span class="n">filedate</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">())</span>
        <span class="n">archfiles_row</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">year</span>
        <span class="n">archfiles_row</span><span class="p">[</span><span class="s1">&#39;doy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">doy</span>
        <span class="n">archfiles_row</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">hdus</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">Ska</span><span class="o">.</span><span class="n">DBI</span><span class="o">.</span><span class="n">DBI</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
            <span class="c1"># remove old versions of this file</span>
            <span class="n">oldmatches</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">fetchall</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;SELECT * from archfiles</span>
<span class="sd">                   WHERE filetime = %(filetime)d</span>
<span class="sd">                   and slot = %(slot)d</span>
<span class="sd">                   and startmjf = %(startmjf)d and startmnf = %(startmnf)d</span>
<span class="sd">                   and stopmjf = %(stopmjf)d and stopmnf = %(stopmnf)d &quot;&quot;&quot;</span>
                <span class="o">%</span> <span class="n">archfiles_row</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">oldmatches</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_arch_remove</span><span class="p">(</span><span class="n">oldmatches</span><span class="p">)</span>

        <span class="n">interval_matches</span> <span class="o">=</span> <span class="n">_get_file_records</span><span class="p">(</span><span class="n">archfiles_row</span><span class="p">[</span><span class="s1">&#39;tstart&#39;</span><span class="p">],</span>
                                              <span class="n">archfiles_row</span><span class="p">[</span><span class="s1">&#39;tstop&#39;</span><span class="p">],</span>
                                              <span class="n">slots</span><span class="o">=</span><span class="p">[</span><span class="n">archfiles_row</span><span class="p">[</span><span class="s1">&#39;slot&#39;</span><span class="p">]])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interval_matches</span><span class="p">):</span>
            <span class="c1"># if there are files there that still overlap the new file</span>
            <span class="c1"># and they are all older, remove the old files.</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">interval_matches</span><span class="p">[</span><span class="s1">&#39;revision&#39;</span><span class="p">]</span>
                      <span class="o">&lt;</span> <span class="n">archfiles_row</span><span class="p">[</span><span class="s1">&#39;revision&#39;</span><span class="p">]):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;removing overlapping files at older revision(s)&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">interval_matches</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_arch_remove</span><span class="p">(</span><span class="n">interval_matches</span><span class="p">)</span>
            <span class="c1"># if the overlapping files are all from the same revision</span>
            <span class="c1"># just ingest them and hope for the best</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">interval_matches</span><span class="p">[</span><span class="s1">&#39;revision&#39;</span><span class="p">]</span>
                        <span class="o">==</span> <span class="n">archfiles_row</span><span class="p">[</span><span class="s1">&#39;revision&#39;</span><span class="p">]):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ignoring overlap for same process revision&quot;</span><span class="p">)</span>
            <span class="c1"># if the files that overlap are all newer, let&#39;s not ingest</span>
            <span class="c1"># the &quot;missing&quot; file</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">interval_matches</span><span class="p">[</span><span class="s1">&#39;revision&#39;</span><span class="p">]</span>
                        <span class="o">&gt;</span> <span class="n">archfiles_row</span><span class="p">[</span><span class="s1">&#39;revision&#39;</span><span class="p">]):</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">archfiles_row</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">interval_matches</span><span class="p">)</span>
                <span class="c1"># throw an error if there is still overlap</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot ingest </span><span class="si">%s</span><span class="s2">, overlaps existing files&quot;</span>
                                 <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">archfiles_row</span>

    <span class="k">def</span> <span class="nf">_arch_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defunct_matches</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">Ska</span><span class="o">.</span><span class="n">DBI</span><span class="o">.</span><span class="n">DBI</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">file_record</span> <span class="ow">in</span> <span class="n">defunct_matches</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;&quot;delete from archfiles</span>
<span class="s2">                              WHERE filetime = </span><span class="si">%(filetime)d</span><span class="s2"></span>
<span class="s2">                              and slot = </span><span class="si">%(slot)d</span><span class="s2"></span>
<span class="s2">                              and startmjf = </span><span class="si">%(startmjf)d</span><span class="s2"></span>
<span class="s2">                              and startmnf = </span><span class="si">%(startmnf)d</span><span class="s2"></span>
<span class="s2">                              and stopmjf = </span><span class="si">%(stopmjf)d</span><span class="s2"></span>
<span class="s2">                              and stopmnf = </span><span class="si">%(stopmnf)d</span><span class="s2"> &quot;&quot;&quot;</span>
                           <span class="o">%</span> <span class="n">file_record</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">archdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data_root</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">file_record</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]),</span>
                        <span class="s2">&quot;</span><span class="si">{0:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_record</span><span class="p">[</span><span class="s1">&#39;doy&#39;</span><span class="p">])</span>
                        <span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;deleting </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">archdir</span><span class="p">,</span> <span class="n">file_record</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]))</span>
                <span class="n">real_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">archdir</span><span class="p">,</span> <span class="n">file_record</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">real_file</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">real_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_move_archive_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">archfiles</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move ACA L0 files into the file archive into directories</span>
<span class="sd">        by YYYY/DOY under the specified data_root</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data_root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_root</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">data_root</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">data_root</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">archfiles</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="c1"># use the timestamp right from the ACA0 filename</span>
            <span class="n">tstart</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+)&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">basename</span><span class="p">))</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">datestart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">tstart</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">doy</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d\d\d\d):(\d\d\d)&#39;</span><span class="p">,</span> <span class="n">datestart</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">archdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_root</span><span class="p">,</span>
                                                   <span class="n">year</span><span class="p">,</span>
                                                   <span class="n">doy</span><span class="p">))</span>
            <span class="c1"># construct the destination filepath/name</span>
            <span class="n">archfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">archdir</span><span class="p">,</span> <span class="n">basename</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">archdir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">archdir</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">archfile</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;mv </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">archfile</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mo">0o775</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">archfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Unlinking </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fetch_by_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">range_tstart</span><span class="p">,</span> <span class="n">range_tstop</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fetching </span><span class="si">%s</span><span class="s2"> from </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span> 
                    <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;ACA L0 Data&#39;</span><span class="p">,</span>
                       <span class="n">DateTime</span><span class="p">(</span><span class="n">range_tstart</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">,</span>
                       <span class="n">DateTime</span><span class="p">(</span><span class="n">range_tstop</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
        <span class="n">archfiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_archive_files</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">range_tstart</span><span class="p">),</span>
                                            <span class="n">DateTime</span><span class="p">(</span><span class="n">range_tstop</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">archfiles</span>

    <span class="k">def</span> <span class="nf">_fetch_individual_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
        <span class="n">arc5</span> <span class="o">=</span> <span class="n">Ska</span><span class="o">.</span><span class="n">arc5gl</span><span class="o">.</span><span class="n">Arc5gl</span><span class="p">(</span><span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;********** </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> **********&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filetype</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">],</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()))</span>
        <span class="n">fetched_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ingest_dates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># get the files, store in file archive, and record in database</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="c1"># Retrieve CXC archive files in a temp directory with arc5gl</span>
            <span class="n">missed_file</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span>
            <span class="n">arc5</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;dataset=flight&#39;</span><span class="p">)</span>
            <span class="n">arc5</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;detector=pcad&#39;</span><span class="p">)</span>
            <span class="n">arc5</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;subdetector=aca&#39;</span><span class="p">)</span>
            <span class="n">arc5</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;level=0&#39;</span><span class="p">)</span>
            <span class="n">arc5</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;filename=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">missed_file</span><span class="p">)</span>
            <span class="n">arc5</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;version=last&#39;</span><span class="p">)</span>
            <span class="n">arc5</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;operation=retrieve&#39;</span><span class="p">)</span>
            <span class="n">arc5</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;go&#39;</span><span class="p">)</span>
            <span class="n">have_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">missed_file</span><span class="si">}</span><span class="s2">*&quot;</span><span class="p">))</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">have_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># if it isn&#39;t gzipped, just gzip it</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;.*\.fits$&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
                <span class="n">f_in</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
                <span class="n">f_out</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.gz&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                <span class="n">f_out</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">f_in</span><span class="p">)</span>
                <span class="n">f_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">f_in</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.gz&quot;</span> <span class="o">%</span> <span class="n">filename</span>
            <span class="n">fetched_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">ingest_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="p">[</span><span class="s1">&#39;ingest_date&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">fetched_files</span><span class="p">,</span> <span class="n">ingest_dates</span>

    <span class="k">def</span> <span class="nf">_insert_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
        <span class="n">count_inserted</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
            <span class="n">arch_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_archfile</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arch_info</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_move_archive_files</span><span class="p">([</span><span class="n">f</span><span class="p">])</span>
                <span class="k">with</span> <span class="n">Ska</span><span class="o">.</span><span class="n">DBI</span><span class="o">.</span><span class="n">DBI</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">arch_info</span><span class="p">,</span> <span class="s1">&#39;archfiles&#39;</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">count_inserted</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ingested </span><span class="si">%d</span><span class="s2"> files&quot;</span> <span class="o">%</span> <span class="n">count_inserted</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve ACA0 telemetry files from the CXC archive, store in the</span>
<span class="sd">        Ska/ACA archive, and update database of files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">contentdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_root</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">contentdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">contentdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_root</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_root</span><span class="p">)</span>
        <span class="n">archdb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">contentdir</span><span class="p">,</span> <span class="s1">&#39;archfiles.db3&#39;</span><span class="p">)</span>
        <span class="c1"># if the database of the archived files does not exist,</span>
        <span class="c1"># or is empty, make it</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">archdb</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">archdb</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;creating archfiles db from </span><span class="si">%s</span><span class="s2">&quot;</span>
                        <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_def</span><span class="p">)</span>
            <span class="n">db_sql</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_def</span>
            <span class="n">db_init_cmds</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">db_sql</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">Ska</span><span class="o">.</span><span class="n">DBI</span><span class="o">.</span><span class="n">DBI</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
                <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">db_init_cmds</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
            <span class="n">datestart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Get datestart as the most-recent file time from archfiles table</span>
            <span class="c1"># will need min-of-max-slot-datestart</span>
            <span class="k">with</span> <span class="n">Ska</span><span class="o">.</span><span class="n">DBI</span><span class="o">.</span><span class="n">DBI</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
                <span class="n">last_time</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">db</span><span class="o">.</span><span class="n">fetchone</span><span class="p">(</span>
                            <span class="s2">&quot;select max(filetime) from archfiles where slot = </span><span class="si">%d</span><span class="s2">&quot;</span>
                            <span class="o">%</span> <span class="n">s</span><span class="p">)[</span><span class="s1">&#39;max(filetime)&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)])</span>
                <span class="k">if</span> <span class="n">last_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;No files in archive to do update-since-last-run mode.</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;Please specify a time with --start&quot;</span><span class="p">)</span>
                <span class="n">datestart</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">last_time</span><span class="p">)</span>
        <span class="n">datestop</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="n">padding_seconds</span> <span class="o">=</span> <span class="mi">10000</span>
        <span class="c1"># loop over the specified time range in chunks of</span>
        <span class="c1"># days_at_once in seconds with some padding</span>
        <span class="k">for</span> <span class="n">tstart</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">datestart</span><span class="o">.</span><span class="n">day_start</span><span class="p">()</span><span class="o">.</span><span class="n">secs</span><span class="p">,</span>
                                <span class="n">datestop</span><span class="o">.</span><span class="n">day_end</span><span class="p">()</span><span class="o">.</span><span class="n">secs</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">days_at_once</span> <span class="o">*</span> <span class="mi">86400</span><span class="p">):</span>
            <span class="c1"># set times for a chunk</span>
            <span class="n">range_tstart</span> <span class="o">=</span> <span class="n">tstart</span> <span class="o">-</span> <span class="n">padding_seconds</span>
            <span class="n">range_tstop</span> <span class="o">=</span> <span class="n">tstart</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">days_at_once</span> <span class="o">*</span> <span class="mi">86400</span>
            <span class="k">if</span> <span class="n">range_tstop</span> <span class="o">&gt;</span> <span class="n">datestop</span><span class="o">.</span><span class="n">day_end</span><span class="p">()</span><span class="o">.</span><span class="n">secs</span><span class="p">:</span>
                <span class="n">range_tstop</span> <span class="o">=</span> <span class="n">datestop</span><span class="o">.</span><span class="n">day_end</span><span class="p">()</span><span class="o">.</span><span class="n">secs</span>
            <span class="n">range_tstop</span> <span class="o">+=</span> <span class="n">padding_seconds</span>
            <span class="c1"># make a temporary directory</span>
            <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">Ska</span><span class="o">.</span><span class="n">File</span><span class="o">.</span><span class="n">TempDir</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_root</span><span class="p">)</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">tmpdir</span><span class="o">.</span><span class="n">name</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Files save to temp dir </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dirname</span><span class="p">)</span>
            <span class="c1"># get the files, store in file archive, and record in database</span>
            <span class="k">with</span> <span class="n">Ska</span><span class="o">.</span><span class="n">File</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
                <span class="n">fetched_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_by_time</span><span class="p">(</span><span class="n">range_tstart</span><span class="p">,</span> <span class="n">range_tstop</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_insert_files</span><span class="p">(</span><span class="n">fetched_files</span><span class="p">)</span>

        <span class="n">timestamp_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_root</span><span class="p">,</span> <span class="s1">&#39;last_timestamp.txt&#39;</span><span class="p">)</span>
        <span class="c1"># get list of missing files since the last time the tool ingested</span>
        <span class="c1"># files.  If this is first run of the tool, check from the start of</span>
        <span class="c1"># the requested time range</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">timestamp_file</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">timestamp_file</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">cda_checked_timestamp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">timestamp_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cda_checked_timestamp</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">date</span>
        <span class="n">missing_datetime</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">cda_checked_timestamp</span><span class="p">)</span>
        <span class="n">missing_files</span><span class="p">,</span> <span class="n">last_ingest_date</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_missing_archive_files</span><span class="p">(</span><span class="n">missing_datetime</span><span class="p">,</span>
                                            <span class="n">only_new</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># update the file to have up through the last confirmed good file</span>
        <span class="c1"># even before we try to fetch missing ones</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">timestamp_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">last_ingest_date</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_files</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> missing individual files&quot;</span>
                        <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_files</span><span class="p">))</span>
            <span class="c1"># make a temporary directory</span>
            <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">Ska</span><span class="o">.</span><span class="n">File</span><span class="o">.</span><span class="n">TempDir</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_root</span><span class="p">)</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">tmpdir</span><span class="o">.</span><span class="n">name</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;File save to temp dir </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dirname</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">Ska</span><span class="o">.</span><span class="n">File</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
                <span class="n">fetched_files</span><span class="p">,</span> <span class="n">ingest_times</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fetch_individual_files</span><span class="p">(</span><span class="n">missing_files</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_insert_files</span><span class="p">(</span><span class="n">fetched_files</span><span class="p">)</span>

            <span class="n">last_ingest_date</span> <span class="o">=</span> <span class="n">missing_files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;ingest_date&#39;</span><span class="p">]</span>
            <span class="c1"># update the file to have up through the last confirmed good file</span>
            <span class="c1"># even before we try to fetch missing ones</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">timestamp_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">last_ingest_date</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No missing files&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Command line interface to fetch ACA L0 telemetry from the CXC Archive</span>
<span class="sd">    and store it in the Ska archive.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">()</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">updater</span> <span class="o">=</span> <span class="n">Updater</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">updater</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2012, Jean Connelly.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 4.2.0. &nbsp;
  </p>
</footer>
  </body>
</html>