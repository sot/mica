
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mica.archive.obspar &#8212; mica 4.31.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-astropy.css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">Ska!</span><span id="logotext2">mi</span><span id="logotext3">ca</span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://cxc.cfa.harvard.edu/mta/ASPECT/tool_doc">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">mica 4.31.0 documentation</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for mica.archive.obspar</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Script to update Ska file archive obspars.  Module</span>
<span class="sd">also provides methods to retrieve the directory (or directories)</span>
<span class="sd">for an obsid.</span>

<span class="sd">This uses the obsid_archive module with a configuration specific</span>
<span class="sd">to the obspar products.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">mica.archive</span> <span class="kn">import</span> <span class="n">obsid_archive</span>
<span class="kn">from</span> <span class="nn">mica.archive.obsid_archive</span> <span class="kn">import</span> <span class="n">parse_obspar</span>
<span class="kn">from</span> <span class="nn">mica.common</span> <span class="kn">import</span> <span class="n">MICA_ARCHIVE</span>

<span class="c1"># these keys are available in the obspar and will be included in the</span>
<span class="c1"># file lookup table (archfiles)</span>
<span class="n">ARCHFILES_HDR_COLS</span> <span class="o">=</span> <span class="p">[</span>
<span class="s1">&#39;filename&#39;</span><span class="p">,</span>
<span class="s1">&#39;obsid&#39;</span><span class="p">,</span>
<span class="s1">&#39;title&#39;</span><span class="p">,</span>
<span class="s1">&#39;observer&#39;</span><span class="p">,</span>
<span class="s1">&#39;ao&#39;</span><span class="p">,</span>
<span class="s1">&#39;object&#39;</span><span class="p">,</span>
<span class="s1">&#39;ss_object&#39;</span><span class="p">,</span>
<span class="s1">&#39;obs_id&#39;</span><span class="p">,</span>
<span class="s1">&#39;obi_num&#39;</span><span class="p">,</span>
<span class="s1">&#39;seq_num&#39;</span><span class="p">,</span>
<span class="s1">&#39;instrume&#39;</span><span class="p">,</span>
<span class="s1">&#39;grating&#39;</span><span class="p">,</span>
<span class="s1">&#39;detector&#39;</span><span class="p">,</span>
<span class="s1">&#39;detnam&#39;</span><span class="p">,</span>
<span class="s1">&#39;si_mode&#39;</span><span class="p">,</span>
<span class="s1">&#39;optical_monitor&#39;</span><span class="p">,</span>
<span class="s1">&#39;raster_scan&#39;</span><span class="p">,</span>
<span class="s1">&#39;dither&#39;</span><span class="p">,</span>
<span class="s1">&#39;dither_y_amp&#39;</span><span class="p">,</span>
<span class="s1">&#39;dither_y_freq&#39;</span><span class="p">,</span>
<span class="s1">&#39;dither_y_phase&#39;</span><span class="p">,</span>
<span class="s1">&#39;dither_z_amp&#39;</span><span class="p">,</span>
<span class="s1">&#39;dither_z_freq&#39;</span><span class="p">,</span>
<span class="s1">&#39;dither_z_phase&#39;</span><span class="p">,</span>
<span class="s1">&#39;ra_pnt&#39;</span><span class="p">,</span>
<span class="s1">&#39;dec_pnt&#39;</span><span class="p">,</span>
<span class="s1">&#39;roll_pnt&#39;</span><span class="p">,</span>
<span class="s1">&#39;ra_targ&#39;</span><span class="p">,</span>
<span class="s1">&#39;dec_targ&#39;</span><span class="p">,</span>
<span class="s1">&#39;y_det_offset&#39;</span><span class="p">,</span>
<span class="s1">&#39;z_det_offset&#39;</span><span class="p">,</span>
<span class="s1">&#39;radial_offset&#39;</span><span class="p">,</span>
<span class="s1">&#39;defocus&#39;</span><span class="p">,</span>
<span class="s1">&#39;sim_z_offset&#39;</span><span class="p">,</span>
<span class="s1">&#39;pre_id&#39;</span><span class="p">,</span>
<span class="s1">&#39;uninterrupted&#39;</span><span class="p">,</span>
<span class="s1">&#39;seg_max_num&#39;</span><span class="p">,</span>
<span class="s1">&#39;ra_nom&#39;</span><span class="p">,</span>
<span class="s1">&#39;dec_nom&#39;</span><span class="p">,</span>
<span class="s1">&#39;roll_nom&#39;</span><span class="p">,</span>
<span class="s1">&#39;date_obs&#39;</span><span class="p">,</span>
<span class="s1">&#39;date_end&#39;</span><span class="p">,</span>
<span class="s1">&#39;tstart&#39;</span><span class="p">,</span>
<span class="s1">&#39;tstop&#39;</span><span class="p">,</span>
<span class="s1">&#39;sched_start&#39;</span><span class="p">,</span>
<span class="s1">&#39;sched_stop&#39;</span><span class="p">,</span>
<span class="s1">&#39;sched_exp_time&#39;</span><span class="p">,</span>
<span class="s1">&#39;obs_mode&#39;</span><span class="p">,</span>
<span class="s1">&#39;maneuver&#39;</span><span class="p">,</span>
<span class="s1">&#39;maneuver_v1&#39;</span><span class="p">,</span>
<span class="s1">&#39;maneuver_v2&#39;</span><span class="p">,</span>
<span class="s1">&#39;maneuver_v3&#39;</span><span class="p">,</span>
<span class="s1">&#39;maneuver_angle&#39;</span><span class="p">,</span>
<span class="s1">&#39;maneuver_ref&#39;</span><span class="p">,</span>
<span class="s1">&#39;mjdref&#39;</span><span class="p">,</span>
<span class="s1">&#39;timezero&#39;</span><span class="p">,</span>
<span class="s1">&#39;timeunit&#39;</span><span class="p">,</span>
<span class="s1">&#39;timesys&#39;</span><span class="p">,</span>
<span class="s1">&#39;timversn&#39;</span><span class="p">,</span>
<span class="s1">&#39;datamode&#39;</span><span class="p">,</span>
<span class="s1">&#39;readmode&#39;</span><span class="p">,</span>
<span class="s1">&#39;ccdi0_on&#39;</span><span class="p">,</span>
<span class="s1">&#39;ccdi1_on&#39;</span><span class="p">,</span>
<span class="s1">&#39;ccdi2_on&#39;</span><span class="p">,</span>
<span class="s1">&#39;ccdi3_on&#39;</span><span class="p">,</span>
<span class="s1">&#39;ccds0_on&#39;</span><span class="p">,</span>
<span class="s1">&#39;ccds1_on&#39;</span><span class="p">,</span>
<span class="s1">&#39;ccds2_on&#39;</span><span class="p">,</span>
<span class="s1">&#39;ccds3_on&#39;</span><span class="p">,</span>
<span class="s1">&#39;ccds4_on&#39;</span><span class="p">,</span>
<span class="s1">&#39;ccds5_on&#39;</span><span class="p">,</span>
<span class="s1">&#39;dropped_chip_count&#39;</span><span class="p">,</span>
<span class="s1">&#39;onchip_sum&#39;</span><span class="p">,</span>
<span class="s1">&#39;sumrow&#39;</span><span class="p">,</span>
<span class="s1">&#39;sumcol&#39;</span><span class="p">,</span>
<span class="s1">&#39;subarray&#39;</span><span class="p">,</span>
<span class="s1">&#39;startrow&#39;</span><span class="p">,</span>
<span class="s1">&#39;rowcnt&#39;</span><span class="p">,</span>
<span class="s1">&#39;subarray_frame_time&#39;</span><span class="p">,</span>
<span class="s1">&#39;duty_cycle&#39;</span><span class="p">,</span>
<span class="s1">&#39;dtycycle&#39;</span><span class="p">,</span>
<span class="s1">&#39;exptimea&#39;</span><span class="p">,</span>
<span class="s1">&#39;exptimeb&#39;</span><span class="p">,</span>
<span class="s1">&#39;most_efficient&#39;</span><span class="p">,</span>
<span class="s1">&#39;eventfilter&#39;</span><span class="p">,</span>
<span class="s1">&#39;phamin&#39;</span><span class="p">,</span>
<span class="s1">&#39;pharange&#39;</span><span class="p">,</span>
<span class="s1">&#39;bias_request&#39;</span><span class="p">,</span>
<span class="s1">&#39;mode&#39;</span><span class="p">,</span>
<span class="s1">&#39;mission&#39;</span><span class="p">,</span>
<span class="s1">&#39;telescop&#39;</span><span class="p">,</span>
<span class="s1">&#39;sim_x&#39;</span><span class="p">,</span>
<span class="s1">&#39;sim_y&#39;</span><span class="p">,</span>
<span class="s1">&#39;sim_z&#39;</span><span class="p">,</span>
<span class="s1">&#39;foc_len&#39;</span><span class="p">,</span>
<span class="s1">&#39;py_shutter_position&#39;</span><span class="p">,</span>
<span class="s1">&#39;range_switch_level&#39;</span><span class="p">,</span>
<span class="s1">&#39;antico_enable&#39;</span><span class="p">,</span>
<span class="s1">&#39;upper_level_disc&#39;</span><span class="p">,</span>
<span class="s1">&#39;timing_mode&#39;</span><span class="p">,</span>
<span class="s1">&#39;trigger_level&#39;</span><span class="p">,</span>
<span class="s1">&#39;u_blank_hi&#39;</span><span class="p">,</span>
<span class="s1">&#39;u_blank_low&#39;</span><span class="p">,</span>
<span class="s1">&#39;v_blank_low&#39;</span><span class="p">,</span>
<span class="s1">&#39;v_blank_hi&#39;</span><span class="p">,</span>
<span class="s1">&#39;uld_enable&#39;</span><span class="p">,</span>
<span class="s1">&#39;zero_block&#39;</span><span class="p">,</span>
<span class="s1">&#39;blank_enable&#39;</span><span class="p">,</span>
<span class="s1">&#39;width_enable&#39;</span><span class="p">,</span>
<span class="s1">&#39;spect_mode&#39;</span><span class="p">,</span>
<span class="s1">&#39;my_shutter_position&#39;</span><span class="p">,</span>
<span class="s1">&#39;width_threshold&#39;</span><span class="p">,</span>
<span class="s1">&#39;mt_a&#39;</span><span class="p">,</span>
<span class="s1">&#39;mt_aop&#39;</span><span class="p">,</span>
<span class="s1">&#39;mt_e&#39;</span><span class="p">,</span>
<span class="s1">&#39;mt_epoch&#39;</span><span class="p">,</span>
<span class="s1">&#39;mt_i&#39;</span><span class="p">,</span>
<span class="s1">&#39;mt_ma&#39;</span><span class="p">,</span>
<span class="s1">&#39;mt_raan&#39;</span><span class="p">,</span>
<span class="s1">&#39;timeref&#39;</span><span class="p">,</span>
<span class="s1">&#39;tassign&#39;</span><span class="p">,</span>
<span class="s1">&#39;origin&#39;</span><span class="p">,</span>
<span class="s1">&#39;ascdsver&#39;</span><span class="p">,</span>
<span class="s1">&#39;obi_data&#39;</span><span class="p">,</span>
<span class="s1">&#39;revision&#39;</span><span class="p">,</span>
<span class="s1">&#39;obspar_ver&#39;</span><span class="p">,</span>
<span class="s1">&#39;obspar_type&#39;</span><span class="p">,</span>
<span class="s1">&#39;obspar_stat&#39;</span><span class="p">]</span>

<span class="n">CONFIG</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data_root</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MICA_ARCHIVE</span><span class="p">,</span> <span class="s1">&#39;obspar&#39;</span><span class="p">),</span>
              <span class="n">temp_root</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MICA_ARCHIVE</span><span class="p">,</span> <span class="s1">&#39;tempobs&#39;</span><span class="p">),</span>
              <span class="n">sql_def</span><span class="o">=</span><span class="s1">&#39;obspar_def.sql&#39;</span><span class="p">,</span>
              <span class="n">apstat_table</span><span class="o">=</span><span class="s1">&#39;obidet_0_5&#39;</span><span class="p">,</span>
              <span class="n">apstat_id</span><span class="o">=</span><span class="s1">&#39;obidet_0_5_id&#39;</span><span class="p">,</span>
              <span class="n">label</span><span class="o">=</span><span class="s1">&#39;obspar&#39;</span><span class="p">,</span>
              <span class="n">small</span><span class="o">=</span><span class="s1">&#39;obspar&#39;</span><span class="p">,</span>
              <span class="n">small_glob</span><span class="o">=</span><span class="s1">&#39;axaff*par*&#39;</span><span class="p">,</span>
              <span class="n">small_ver_regex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;axaff\d</span><span class="si">{5}</span><span class="s1">_\d</span><span class="si">{3}</span><span class="s1">N(\d</span><span class="si">{3}</span><span class="s1">).*&#39;</span><span class="p">,</span>
              <span class="n">full</span><span class="o">=</span><span class="s1">&#39;obspar&#39;</span><span class="p">,</span>
              <span class="n">filecheck</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">cols</span><span class="o">=</span><span class="n">ARCHFILES_HDR_COLS</span><span class="p">,</span>
              <span class="n">content_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;OBSPAR&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">get_options</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    <span class="n">desc</span> <span class="o">=</span> \
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Run the update process to get new obspars, save them in the Ska</span>
<span class="sd">file archive, and include records of them in the file lookup database.</span>
<span class="sd">This is intended to be run as a cron task, and in regular processing,</span>
<span class="sd">the update will fetch and ingest all telemetry since the task&#39;s last run.</span>
<span class="sd">Options also provided to fetch and ingest specific obsids and versions.</span>

<span class="sd">See the ``CONFIG`` in the obspar.py file and the config description in</span>
<span class="sd">obsid_archive for more information on the obspar default config if parameters</span>
<span class="sd">without command-line options need to be changed.</span>
<span class="sd">&quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="o">**</span><span class="n">defaults</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--obsid&quot;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;specific obsid to process&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--version&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;specific processing version to retrieve&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--firstrun&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;for archive init., ignore revisions&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--data-root&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;parent directory for all data&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--temp-root&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;parent temp directory&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--rebuild&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Allow update to rebuild archive from obsid 1&quot;</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">opt</span>

<span class="c1"># set up an archive object with default config for use by the other</span>
<span class="c1"># get_* methods</span>
<span class="n">archive</span> <span class="o">=</span> <span class="n">obsid_archive</span><span class="o">.</span><span class="n">ObsArchive</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">)</span>


<div class="viewcode-block" id="get_dir"><a class="viewcode-back" href="../../../api.html#mica.archive.obspar.get_dir">[docs]</a><span class="k">def</span> <span class="nf">get_dir</span><span class="p">(</span><span class="n">obsid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get obspar directory for default/released products for an obsid.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import obspar</span>
<span class="sd">      &gt;&gt;&gt; obspar.get_dir(2121)</span>
<span class="sd">      &#39;/proj/sot/ska/data/mica/archive/obspar/02/02121&#39;</span>

<span class="sd">    :param obsid: obsid</span>
<span class="sd">    :returns: directory</span>
<span class="sd">    :rtype: string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_dir</span><span class="p">(</span><span class="n">obsid</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_obs_dirs"><a class="viewcode-back" href="../../../api.html#mica.archive.obspar.get_obs_dirs">[docs]</a><span class="k">def</span> <span class="nf">get_obs_dirs</span><span class="p">(</span><span class="n">obsid</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all obspar directories for an obsid in the Ska file archive.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import obspar</span>
<span class="sd">      &gt;&gt;&gt; obsdirs = obspar.get_obs_dirs(6000)</span>

<span class="sd">    obsdirs will look something like::</span>

<span class="sd">      {&#39;default&#39;: &#39;/proj/sot/ska/data/mica/archive/obspar/06/06000&#39;,</span>
<span class="sd">      2: &#39;/proj/sot/ska/data/mica/archive/obspar/06/06000_v02&#39;,</span>
<span class="sd">      3: &#39;/proj/sot/ska/data/mica/archive/obspar/06/06000_v03&#39;,</span>
<span class="sd">      &#39;last&#39;: &#39;/proj/sot/ska/data/mica/archive/obspar/06/06000&#39;,</span>
<span class="sd">      &#39;revisions&#39;: [2, 3]}</span>

<span class="sd">    :param obsid: obsid</span>
<span class="sd">    :returns: map of obsid version to directories</span>
<span class="sd">    :rtype: dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_obs_dirs</span><span class="p">(</span><span class="n">obsid</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">get_obspar_file</span><span class="p">(</span><span class="n">obsid</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get location of requested obsid&#39;s obspar.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import obspar</span>
<span class="sd">      &gt;&gt;&gt; obspar.get_obspar_file(7000)</span>
<span class="sd">      &#39;/proj/sot/ska/data/mica/archive/obspar/07/07000/axaff07000_000N002_obs0a.par.gz&#39;</span>
<span class="sd">      &gt;&gt;&gt; obspar.get_obspar_file(14262, version=1)</span>
<span class="sd">      &#39;/proj/sot/ska/data/mica/archive/obspar/14/14262_v01/axaff14262_001N001_obs0a.par.gz&#39;</span>

<span class="sd">    :param obsid: obsid</span>
<span class="sd">    :param version: processing version/revision</span>

<span class="sd">    :returns: path of obspar or None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dirs</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_obs_dirs</span><span class="p">(</span><span class="n">obsid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dirs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
        <span class="n">obsparfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirs</span><span class="p">[</span><span class="n">version</span><span class="p">],</span> <span class="s1">&#39;axaff*par*&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obsparfiles</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obsparfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="kc">None</span>


<div class="viewcode-block" id="get_obspar"><a class="viewcode-back" href="../../../api.html#mica.archive.obspar.get_obspar">[docs]</a><span class="k">def</span> <span class="nf">get_obspar</span><span class="p">(</span><span class="n">obsid</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the obspar for obsid.  Return as a dict.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import obspar</span>
<span class="sd">      &gt;&gt;&gt; obspar.get_obspar(7001)[&#39;detector&#39;]</span>
<span class="sd">      &#39;ACIS-I&#39;</span>

<span class="sd">    :param obsid: obsid</span>
<span class="sd">    :param version: processing version/revision</span>

<span class="sd">    :returns: dictionary of obspar</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">obsparfile</span> <span class="o">=</span> <span class="n">get_obspar_file</span><span class="p">(</span><span class="n">obsid</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obsparfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">obspar</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;num_ccd_on&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">parse_obspar</span><span class="p">(</span><span class="n">obsparfile</span><span class="p">):</span>
        <span class="n">obspar</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]})</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^ccd[is]\d_on$&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span>
            <span class="n">obspar</span><span class="p">[</span><span class="s1">&#39;num_ccd_on&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">obspar</span></div>


<span class="k">def</span> <span class="nf">get_files</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List obspar files for an obsid or a time range.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import obspar</span>
<span class="sd">      &gt;&gt;&gt; obs_files = obspar.get_files(6000)</span>
<span class="sd">      &gt;&gt;&gt; range = obspar.get_files(start=&#39;2012:001&#39;,</span>
<span class="sd">      ...                          stop=&#39;2012:030&#39;)</span>


<span class="sd">    :param obsid: obsid</span>
<span class="sd">    :param start: time range start (Chandra.Time compatible)</span>
<span class="sd">    :param stop: time range stop (Chandra.Time compatible)</span>
<span class="sd">    :param revision: revision integer or &#39;last&#39;</span>
<span class="sd">                     defaults to current released version</span>
<span class="sd">    :returns: full path of files matching query</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_files</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="n">obsid</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                             <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_obsids</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List obsids with obspars in a time range.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import obspar</span>
<span class="sd">      &gt;&gt;&gt; obsids = obspar.get_obsids(&#39;2015:001&#39;, &#39;2015:003&#39;)</span>

<span class="sd">    To retrieve the complete set of obsids used over a time range,</span>
<span class="sd">    use kadi (kadi.events.obsid) instead of this obspar-based method.</span>

<span class="sd">    :param start: time range start (Chandra.Time compatible)</span>
<span class="sd">    :param stop: time range stop (Chandra.Time compatible)</span>
<span class="sd">    :param revision: None, revision integer, or &#39;last&#39;</span>
<span class="sd">                     None is equivalent to limiting the search</span>
<span class="sd">                     to those with &#39;default&#39;/released obspars.</span>
<span class="sd">    :returns: list of obsids</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">_get_file_records</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                                      <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;obsid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the update process to get new obspars, save them in the Ska</span>
<span class="sd">    file archive, and include new entries in the file lookup database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">archive</span> <span class="o">=</span> <span class="n">obsid_archive</span><span class="o">.</span><span class="n">ObsArchive</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">archive</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">archive</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">())</span>
    <span class="n">archive</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2012, Jean Connelly.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 4.2.0. &nbsp;
  </p>
</footer>
  </body>
</html>