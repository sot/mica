<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mica.archive.obspar &#8212; mica 4.38.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-astropy.css?v=f4f7060c" />
    
    <script src="../../../_static/documentation_options.js?v=2b43df8f"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">Ska!</span><span id="logotext2">mi</span><span id="logotext3">ca</span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://cxc.cfa.harvard.edu/mta/ASPECT/tool_doc">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">mica 4.38.1 documentation</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for mica.archive.obspar</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Script to update Ska file archive obspars.</span>

<span class="sd">Module also provides methods to retrieve the directory (or directories)</span>
<span class="sd">for an obsid.</span>

<span class="sd">This uses the obsid_archive module with a configuration specific</span>
<span class="sd">to the obspar products.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>

<span class="kn">from</span> <span class="nn">mica.archive</span> <span class="kn">import</span> <span class="n">obsid_archive</span>
<span class="kn">from</span> <span class="nn">mica.archive.obsid_archive</span> <span class="kn">import</span> <span class="n">parse_obspar</span>
<span class="kn">from</span> <span class="nn">mica.common</span> <span class="kn">import</span> <span class="n">MICA_ARCHIVE</span>

<span class="c1"># these keys are available in the obspar and will be included in the</span>
<span class="c1"># file lookup table (archfiles)</span>
<span class="n">ARCHFILES_HDR_COLS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;filename&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obsid&quot;</span><span class="p">,</span>
    <span class="s2">&quot;title&quot;</span><span class="p">,</span>
    <span class="s2">&quot;observer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ao&quot;</span><span class="p">,</span>
    <span class="s2">&quot;object&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ss_object&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obs_id&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obi_num&quot;</span><span class="p">,</span>
    <span class="s2">&quot;seq_num&quot;</span><span class="p">,</span>
    <span class="s2">&quot;instrume&quot;</span><span class="p">,</span>
    <span class="s2">&quot;grating&quot;</span><span class="p">,</span>
    <span class="s2">&quot;detector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;detnam&quot;</span><span class="p">,</span>
    <span class="s2">&quot;si_mode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;optical_monitor&quot;</span><span class="p">,</span>
    <span class="s2">&quot;raster_scan&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dither&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dither_y_amp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dither_y_freq&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dither_y_phase&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dither_z_amp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dither_z_freq&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dither_z_phase&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ra_pnt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dec_pnt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;roll_pnt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ra_targ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dec_targ&quot;</span><span class="p">,</span>
    <span class="s2">&quot;y_det_offset&quot;</span><span class="p">,</span>
    <span class="s2">&quot;z_det_offset&quot;</span><span class="p">,</span>
    <span class="s2">&quot;radial_offset&quot;</span><span class="p">,</span>
    <span class="s2">&quot;defocus&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sim_z_offset&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pre_id&quot;</span><span class="p">,</span>
    <span class="s2">&quot;uninterrupted&quot;</span><span class="p">,</span>
    <span class="s2">&quot;seg_max_num&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ra_nom&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dec_nom&quot;</span><span class="p">,</span>
    <span class="s2">&quot;roll_nom&quot;</span><span class="p">,</span>
    <span class="s2">&quot;date_obs&quot;</span><span class="p">,</span>
    <span class="s2">&quot;date_end&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tstart&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tstop&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sched_start&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sched_stop&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sched_exp_time&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obs_mode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;maneuver&quot;</span><span class="p">,</span>
    <span class="s2">&quot;maneuver_v1&quot;</span><span class="p">,</span>
    <span class="s2">&quot;maneuver_v2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;maneuver_v3&quot;</span><span class="p">,</span>
    <span class="s2">&quot;maneuver_angle&quot;</span><span class="p">,</span>
    <span class="s2">&quot;maneuver_ref&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mjdref&quot;</span><span class="p">,</span>
    <span class="s2">&quot;timezero&quot;</span><span class="p">,</span>
    <span class="s2">&quot;timeunit&quot;</span><span class="p">,</span>
    <span class="s2">&quot;timesys&quot;</span><span class="p">,</span>
    <span class="s2">&quot;timversn&quot;</span><span class="p">,</span>
    <span class="s2">&quot;datamode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;readmode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ccdi0_on&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ccdi1_on&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ccdi2_on&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ccdi3_on&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ccds0_on&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ccds1_on&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ccds2_on&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ccds3_on&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ccds4_on&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ccds5_on&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dropped_chip_count&quot;</span><span class="p">,</span>
    <span class="s2">&quot;onchip_sum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sumrow&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sumcol&quot;</span><span class="p">,</span>
    <span class="s2">&quot;subarray&quot;</span><span class="p">,</span>
    <span class="s2">&quot;startrow&quot;</span><span class="p">,</span>
    <span class="s2">&quot;rowcnt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;subarray_frame_time&quot;</span><span class="p">,</span>
    <span class="s2">&quot;duty_cycle&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dtycycle&quot;</span><span class="p">,</span>
    <span class="s2">&quot;exptimea&quot;</span><span class="p">,</span>
    <span class="s2">&quot;exptimeb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;most_efficient&quot;</span><span class="p">,</span>
    <span class="s2">&quot;eventfilter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;phamin&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pharange&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bias_request&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mission&quot;</span><span class="p">,</span>
    <span class="s2">&quot;telescop&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sim_x&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sim_y&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sim_z&quot;</span><span class="p">,</span>
    <span class="s2">&quot;foc_len&quot;</span><span class="p">,</span>
    <span class="s2">&quot;py_shutter_position&quot;</span><span class="p">,</span>
    <span class="s2">&quot;range_switch_level&quot;</span><span class="p">,</span>
    <span class="s2">&quot;antico_enable&quot;</span><span class="p">,</span>
    <span class="s2">&quot;upper_level_disc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;timing_mode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;trigger_level&quot;</span><span class="p">,</span>
    <span class="s2">&quot;u_blank_hi&quot;</span><span class="p">,</span>
    <span class="s2">&quot;u_blank_low&quot;</span><span class="p">,</span>
    <span class="s2">&quot;v_blank_low&quot;</span><span class="p">,</span>
    <span class="s2">&quot;v_blank_hi&quot;</span><span class="p">,</span>
    <span class="s2">&quot;uld_enable&quot;</span><span class="p">,</span>
    <span class="s2">&quot;zero_block&quot;</span><span class="p">,</span>
    <span class="s2">&quot;blank_enable&quot;</span><span class="p">,</span>
    <span class="s2">&quot;width_enable&quot;</span><span class="p">,</span>
    <span class="s2">&quot;spect_mode&quot;</span><span class="p">,</span>
    <span class="s2">&quot;my_shutter_position&quot;</span><span class="p">,</span>
    <span class="s2">&quot;width_threshold&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mt_a&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mt_aop&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mt_e&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mt_epoch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mt_i&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mt_ma&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mt_raan&quot;</span><span class="p">,</span>
    <span class="s2">&quot;timeref&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tassign&quot;</span><span class="p">,</span>
    <span class="s2">&quot;origin&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ascdsver&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obi_data&quot;</span><span class="p">,</span>
    <span class="s2">&quot;revision&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obspar_ver&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obspar_type&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obspar_stat&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">CONFIG</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">data_root</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MICA_ARCHIVE</span><span class="p">,</span> <span class="s2">&quot;obspar&quot;</span><span class="p">),</span>
    <span class="n">temp_root</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MICA_ARCHIVE</span><span class="p">,</span> <span class="s2">&quot;tempobs&quot;</span><span class="p">),</span>
    <span class="n">sql_def</span><span class="o">=</span><span class="s2">&quot;obspar_def.sql&quot;</span><span class="p">,</span>
    <span class="n">apstat_table</span><span class="o">=</span><span class="s2">&quot;obidet_0_5&quot;</span><span class="p">,</span>
    <span class="n">apstat_id</span><span class="o">=</span><span class="s2">&quot;obidet_0_5_id&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;obspar&quot;</span><span class="p">,</span>
    <span class="n">small</span><span class="o">=</span><span class="s2">&quot;obspar&quot;</span><span class="p">,</span>
    <span class="n">small_glob</span><span class="o">=</span><span class="s2">&quot;axaff*par*&quot;</span><span class="p">,</span>
    <span class="n">small_ver_regex</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;axaff\d</span><span class="si">{5}</span><span class="s2">_\d</span><span class="si">{3}</span><span class="s2">N(\d</span><span class="si">{3}</span><span class="s2">).*&quot;</span><span class="p">,</span>
    <span class="n">full</span><span class="o">=</span><span class="s2">&quot;obspar&quot;</span><span class="p">,</span>
    <span class="n">filecheck</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cols</span><span class="o">=</span><span class="n">ARCHFILES_HDR_COLS</span><span class="p">,</span>
    <span class="n">content_types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;OBSPAR&quot;</span><span class="p">],</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">get_options</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">argparse</span>

    <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Run the update process to get new obspars, save them in the Ska</span>
<span class="s2">file archive, and include records of them in the file lookup database.</span>
<span class="s2">This is intended to be run as a cron task, and in regular processing,</span>
<span class="s2">the update will fetch and ingest all telemetry since the task&#39;s last run.</span>
<span class="s2">Options also provided to fetch and ingest specific obsids and versions.</span>

<span class="s2">See the ``CONFIG`` in the obspar.py file and the config description in</span>
<span class="s2">obsid_archive for more information on the obspar default config if parameters</span>
<span class="s2">without command-line options need to be changed.</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="o">**</span><span class="n">defaults</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--obsid&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;specific obsid to process&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--version&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;specific processing version to retrieve&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--firstrun&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;for archive init., ignore revisions&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--data-root&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;parent directory for all data&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--temp-root&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;parent temp directory&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--rebuild&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Allow update to rebuild archive from obsid 1&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">opt</span>


<span class="c1"># set up an archive object with default config for use by the other</span>
<span class="c1"># get_* methods</span>
<span class="n">archive</span> <span class="o">=</span> <span class="n">obsid_archive</span><span class="o">.</span><span class="n">ObsArchive</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">)</span>


<div class="viewcode-block" id="get_dir">
<a class="viewcode-back" href="../../../api.html#mica.archive.obspar.get_dir">[docs]</a>
<span class="k">def</span> <span class="nf">get_dir</span><span class="p">(</span><span class="n">obsid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get obspar directory for default/released products for an obsid.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import obspar</span>
<span class="sd">      &gt;&gt;&gt; obspar.get_dir(2121)</span>
<span class="sd">      &#39;/proj/sot/ska/data/mica/archive/obspar/02/02121&#39;</span>

<span class="sd">    :param obsid: obsid</span>
<span class="sd">    :returns: directory</span>
<span class="sd">    :rtype: string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_dir</span><span class="p">(</span><span class="n">obsid</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_obs_dirs">
<a class="viewcode-back" href="../../../api.html#mica.archive.obspar.get_obs_dirs">[docs]</a>
<span class="k">def</span> <span class="nf">get_obs_dirs</span><span class="p">(</span><span class="n">obsid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all obspar directories for an obsid in the Ska file archive.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import obspar</span>
<span class="sd">      &gt;&gt;&gt; obsdirs = obspar.get_obs_dirs(6000)</span>

<span class="sd">    obsdirs will look something like::</span>

<span class="sd">      {&#39;default&#39;: &#39;/proj/sot/ska/data/mica/archive/obspar/06/06000&#39;,</span>
<span class="sd">      2: &#39;/proj/sot/ska/data/mica/archive/obspar/06/06000_v02&#39;,</span>
<span class="sd">      3: &#39;/proj/sot/ska/data/mica/archive/obspar/06/06000_v03&#39;,</span>
<span class="sd">      &#39;last&#39;: &#39;/proj/sot/ska/data/mica/archive/obspar/06/06000&#39;,</span>
<span class="sd">      &#39;revisions&#39;: [2, 3]}</span>

<span class="sd">    :param obsid: obsid</span>
<span class="sd">    :returns: map of obsid version to directories</span>
<span class="sd">    :rtype: dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_obs_dirs</span><span class="p">(</span><span class="n">obsid</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">get_obspar_file</span><span class="p">(</span><span class="n">obsid</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get location of requested obsid&#39;s obspar.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import obspar</span>
<span class="sd">      &gt;&gt;&gt; obspar.get_obspar_file(7000)</span>
<span class="sd">      &#39;/proj/sot/ska/data/mica/archive/obspar/07/07000/axaff07000_000N002_obs0a.par.gz&#39;</span>
<span class="sd">      &gt;&gt;&gt; obspar.get_obspar_file(14262, version=1)</span>
<span class="sd">      &#39;/proj/sot/ska/data/mica/archive/obspar/14/14262_v01/axaff14262_001N001_obs0a.par.gz&#39;</span>

<span class="sd">    :param obsid: obsid</span>
<span class="sd">    :param version: processing version/revision</span>

<span class="sd">    :returns: path of obspar or None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dirs</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_obs_dirs</span><span class="p">(</span><span class="n">obsid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dirs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
        <span class="n">obsparfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirs</span><span class="p">[</span><span class="n">version</span><span class="p">],</span> <span class="s2">&quot;axaff*par*&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obsparfiles</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">obsparfiles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="kc">None</span>


<div class="viewcode-block" id="get_obspar">
<a class="viewcode-back" href="../../../api.html#mica.archive.obspar.get_obspar">[docs]</a>
<span class="k">def</span> <span class="nf">get_obspar</span><span class="p">(</span><span class="n">obsid</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the obspar for obsid.  Return as a dict.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import obspar</span>
<span class="sd">      &gt;&gt;&gt; obspar.get_obspar(7001)[&#39;detector&#39;]</span>
<span class="sd">      &#39;ACIS-I&#39;</span>

<span class="sd">    :param obsid: obsid</span>
<span class="sd">    :param version: processing version/revision</span>

<span class="sd">    :returns: dictionary of obspar</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">obsparfile</span> <span class="o">=</span> <span class="n">get_obspar_file</span><span class="p">(</span><span class="n">obsid</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obsparfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">obspar</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;num_ccd_on&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">parse_obspar</span><span class="p">(</span><span class="n">obsparfile</span><span class="p">):</span>
        <span class="n">obspar</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]})</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^ccd[is]\d_on$&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span>
            <span class="n">obspar</span><span class="p">[</span><span class="s2">&quot;num_ccd_on&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">obspar</span></div>



<span class="k">def</span> <span class="nf">get_files</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List obspar files for an obsid or a time range.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import obspar</span>
<span class="sd">      &gt;&gt;&gt; obs_files = obspar.get_files(6000)</span>
<span class="sd">      &gt;&gt;&gt; range = obspar.get_files(start=&#39;2012:001&#39;,</span>
<span class="sd">      ...                          stop=&#39;2012:030&#39;)</span>


<span class="sd">    :param obsid: obsid</span>
<span class="sd">    :param start: time range start (Chandra.Time compatible)</span>
<span class="sd">    :param stop: time range stop (Chandra.Time compatible)</span>
<span class="sd">    :param revision: revision integer or &#39;last&#39;</span>
<span class="sd">                     defaults to current released version</span>
<span class="sd">    :returns: full path of files matching query</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_files</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="n">obsid</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_obsids</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List obsids with obspars in a time range.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import obspar</span>
<span class="sd">      &gt;&gt;&gt; obsids = obspar.get_obsids(&#39;2015:001&#39;, &#39;2015:003&#39;)</span>

<span class="sd">    To retrieve the complete set of obsids used over a time range,</span>
<span class="sd">    use kadi (kadi.events.obsid) instead of this obspar-based method.</span>

<span class="sd">    :param start: time range start (Chandra.Time compatible)</span>
<span class="sd">    :param stop: time range stop (Chandra.Time compatible)</span>
<span class="sd">    :param revision: None, revision integer, or &#39;last&#39;</span>
<span class="sd">                     None is equivalent to limiting the search</span>
<span class="sd">                     to those with &#39;default&#39;/released obspars.</span>
<span class="sd">    :returns: list of obsids</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">_get_file_records</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">files</span><span class="p">[</span><span class="s2">&quot;obsid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the obspar archive.</span>

<span class="sd">    Run the update process to get new obspars, save them in the Ska</span>
<span class="sd">    file archive, and include new entries in the file lookup database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">archive</span> <span class="o">=</span> <span class="n">obsid_archive</span><span class="o">.</span><span class="n">ObsArchive</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">archive</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">archive</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">())</span>
    <span class="n">archive</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2012, Jean Connelly.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 8.1.3. &nbsp;
  </p>
</footer>
  </body>
</html>