
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mica.archive.asp_l1 &#8212; mica 4.33.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/bootstrap-astropy.css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">Ska!</span><span id="logotext2">mi</span><span id="logotext3">ca</span></a>
  <ul>
    
    <li><a class="home" title="Homepage" href="https://cxc.cfa.harvard.edu/mta/ASPECT/tool_doc">
        <span id="logotext1">ska</span><span id="logotext2">tools</span>
    </a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">mica 4.33.2 documentation</a>
	 &#187;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for mica.archive.asp_l1</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE.rst</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Script to update Ska file archive aspect L1 products.  Module</span>
<span class="sd">also provides methods to retrieve the directory (or directories)</span>
<span class="sd">for an obsid.</span>

<span class="sd">This uses the obsid_archive module with a configuration specific</span>
<span class="sd">to the aspect L1 products.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">Quaternion</span> <span class="kn">import</span> <span class="n">Quat</span>

<span class="kn">from</span> <span class="nn">mica.archive</span> <span class="kn">import</span> <span class="n">obsid_archive</span>
<span class="kn">from</span> <span class="nn">mica.archive</span> <span class="kn">import</span> <span class="n">asp_l1_proc</span>
<span class="kn">from</span> <span class="nn">mica.common</span> <span class="kn">import</span> <span class="n">MICA_ARCHIVE</span>

<span class="c1"># these columns are available in the headers of the fetched telemetry</span>
<span class="c1"># for this product (ASP L1) and will be included in the file lookup table</span>
<span class="n">ARCHFILES_HDR_COLS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;tstart&#39;</span><span class="p">,</span> <span class="s1">&#39;tstop&#39;</span><span class="p">,</span> <span class="s1">&#39;caldbver&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;ascdsver&#39;</span><span class="p">,</span> <span class="s1">&#39;revision&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">)</span>

<span class="c1">#config = ConfigObj(&#39;asp1.conf&#39;)</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data_root</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MICA_ARCHIVE</span><span class="p">,</span> <span class="s1">&#39;asp1&#39;</span><span class="p">),</span>
              <span class="n">temp_root</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MICA_ARCHIVE</span><span class="p">,</span> <span class="s1">&#39;temp&#39;</span><span class="p">),</span>
              <span class="n">bad_obsids</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MICA_ARCHIVE</span><span class="p">,</span> <span class="s1">&#39;asp1&#39;</span><span class="p">,</span> <span class="s1">&#39;asp_l1_bad_obsids.dat&#39;</span><span class="p">),</span>
              <span class="n">sql_def</span><span class="o">=</span><span class="s1">&#39;archfiles_asp_l1_def.sql&#39;</span><span class="p">,</span>
              <span class="n">apstat_table</span><span class="o">=</span><span class="s1">&#39;aspect_1&#39;</span><span class="p">,</span>
              <span class="n">apstat_id</span><span class="o">=</span><span class="s1">&#39;aspect_1_id&#39;</span><span class="p">,</span>
              <span class="n">label</span><span class="o">=</span><span class="s1">&#39;asp_l1&#39;</span><span class="p">,</span>
              <span class="n">small</span><span class="o">=</span><span class="s1">&#39;asp1</span><span class="si">{fidprops}</span><span class="s1">&#39;</span><span class="p">,</span>
              <span class="n">small_glob</span><span class="o">=</span><span class="s1">&#39;*fidpr*&#39;</span><span class="p">,</span>
              <span class="n">small_ver_regex</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;pcadf\d+N(\d</span><span class="si">{3}</span><span class="s1">)_&#39;</span><span class="p">,</span>
              <span class="n">delete</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;kalm1&#39;</span><span class="p">,</span> <span class="s1">&#39;gdat&#39;</span><span class="p">,</span> <span class="s1">&#39;adat&#39;</span><span class="p">],</span>
              <span class="n">full</span><span class="o">=</span><span class="s1">&#39;asp1&#39;</span><span class="p">,</span>
              <span class="n">filecheck</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">cols</span><span class="o">=</span><span class="n">ARCHFILES_HDR_COLS</span><span class="p">,</span>
              <span class="n">content_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ASPQUAL&#39;</span><span class="p">,</span> <span class="s1">&#39;ASPSOL&#39;</span><span class="p">,</span> <span class="s1">&#39;ACADATA&#39;</span><span class="p">,</span> <span class="s1">&#39;GSPROPS&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;GYRODATA&#39;</span><span class="p">,</span> <span class="s1">&#39;KALMAN&#39;</span><span class="p">,</span> <span class="s1">&#39;ACACAL&#39;</span><span class="p">,</span> <span class="s1">&#39;ACACENT&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;FIDPROPS&#39;</span><span class="p">,</span> <span class="s1">&#39;GYROCAL&#39;</span><span class="p">,</span> <span class="s1">&#39;ACA_BADPIX&#39;</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">get_options</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    <span class="n">desc</span> <span class="o">=</span> \
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Run the update process to get new ASP L1 telemetry, save it in the Ska</span>
<span class="sd">file archive, and include it in the file lookup database.  This is intended</span>
<span class="sd">to be run as a cron task, and in regular processing, the update will fetch</span>
<span class="sd">and ingest all telemetry since the task&#39;s last run.  Options also provided</span>
<span class="sd">to fetch and ingest specific obsids and versions.</span>

<span class="sd">See the ``CONFIG`` in the asp_l1.py file and the config description in</span>
<span class="sd">obsid_archive for more information on the asp l1 default config if parameters</span>
<span class="sd">without command-line options need to be changed.</span>
<span class="sd">&quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">)</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">set_defaults</span><span class="p">(</span><span class="o">**</span><span class="n">defaults</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--obsid&quot;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;specific obsid to process&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--version&quot;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;specific processing version to retrieve&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--firstrun&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;for archive init., ignore rev in aspect_1 table&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--data-root&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;parent directory for all data&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--temp-root&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;parent temp directory&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--filecheck&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;for provisional data, download files and check&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot; that all are present.  If unset, proceed if dir&quot;</span>
                        <span class="o">+</span> <span class="s2">&quot; exists&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--rebuild&quot;</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Allow update to rebuild archive from obsid 1&quot;</span><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">opt</span>

<span class="c1"># set up an archive object with default config for use by the other</span>
<span class="c1"># get_* methods</span>
<span class="n">archive</span> <span class="o">=</span> <span class="n">obsid_archive</span><span class="o">.</span><span class="n">ObsArchive</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">)</span>


<div class="viewcode-block" id="get_dir"><a class="viewcode-back" href="../../../api.html#mica.archive.asp_l1.get_dir">[docs]</a><span class="k">def</span> <span class="nf">get_dir</span><span class="p">(</span><span class="n">obsid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get ASP L1 directory for default/released products for an obsid.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import asp_l1</span>
<span class="sd">      &gt;&gt;&gt; asp_l1.get_dir(2121)</span>
<span class="sd">      &#39;/proj/sot/ska/data/mica/archive/asp1/02/02121&#39;</span>

<span class="sd">    :param obsid: obsid</span>
<span class="sd">    :returns: directory</span>
<span class="sd">    :rtype: string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_dir</span><span class="p">(</span><span class="n">obsid</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_obs_dirs"><a class="viewcode-back" href="../../../api.html#mica.archive.asp_l1.get_obs_dirs">[docs]</a><span class="k">def</span> <span class="nf">get_obs_dirs</span><span class="p">(</span><span class="n">obsid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all ASP L1 directories for an obsid in the Ska file archive.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import asp_l1</span>
<span class="sd">      &gt;&gt;&gt; obsdirs = asp_l1.get_obs_dirs(6000)</span>

<span class="sd">    obsdirs will look something like::</span>

<span class="sd">      {&#39;default&#39;: &#39;/proj/sot/ska/data/mica/archive/asp1/06/06000&#39;,</span>
<span class="sd">      2: &#39;/proj/sot/ska/data/mica/archive/asp1/06/06000_v02&#39;,</span>
<span class="sd">      3: &#39;/proj/sot/ska/data/mica/archive/asp1/06/06000_v03&#39;,</span>
<span class="sd">      &#39;last&#39;: &#39;/proj/sot/ska/data/mica/archive/asp1/06/06000&#39;,</span>
<span class="sd">      &#39;revisions&#39;: [2, 3]}</span>

<span class="sd">    :param obsid: obsid</span>
<span class="sd">    :returns: map of obsid version to directories</span>
<span class="sd">    :rtype: dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_obs_dirs</span><span class="p">(</span><span class="n">obsid</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_files"><a class="viewcode-back" href="../../../api.html#mica.archive.asp_l1.get_files">[docs]</a><span class="k">def</span> <span class="nf">get_files</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">revision</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List asp_l1 files for an obsid or a time range.</span>

<span class="sd">      &gt;&gt;&gt; from mica.archive import asp_l1</span>
<span class="sd">      &gt;&gt;&gt; obs_files = asp_l1.get_files(6000)</span>
<span class="sd">      &gt;&gt;&gt; obs_gspr = asp_l1.get_files(6000, content=[&#39;GSPROPS&#39;])</span>
<span class="sd">      &gt;&gt;&gt; range_fidpr = asp_l1.get_files(start=&#39;2012:001&#39;,</span>
<span class="sd">      ...                                stop=&#39;2012:030&#39;,</span>
<span class="sd">      ...                                content=[&#39;FIDPROPS&#39;])</span>


<span class="sd">    The available content types are: ASPQUAL, ASPSOL, ASPSOLOBI, ACACAL,</span>
<span class="sd">    ACA_BADPIX, FIDPROPS, GYROCAL, GSPROPS, and ACACENT.</span>

<span class="sd">    :param obsid: obsid</span>
<span class="sd">    :param start: time range start (Chandra.Time compatible)</span>
<span class="sd">    :param stop: time range stop (Chandra.Time compatible)</span>
<span class="sd">    :param revision: revision integer or &#39;last&#39;</span>
<span class="sd">                     defaults to current released version</span>
<span class="sd">    :param content: archive CONTENT type</span>
<span class="sd">                    defaults to all available ASP1 types</span>
<span class="sd">    :returns: full path of files matching query</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">archive</span><span class="o">.</span><span class="n">get_files</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="n">obsid</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                             <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_atts"><a class="viewcode-back" href="../../../api.html#mica.archive.asp_l1.get_atts">[docs]</a><span class="k">def</span> <span class="nf">get_atts</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the ground aspect solution quaternions and times covering obsid or start to stop,</span>
<span class="sd">    in the ACA frame.</span>

<span class="sd">    :obsid: obsid</span>
<span class="sd">    :start: start time (DateTime compat)</span>
<span class="sd">    :stop: stop time (DateTime compat)</span>
<span class="sd">    :revision: aspect pipeline processing revision (integer version, None, or &#39;last&#39;)</span>
<span class="sd">    :filter: boolean, true means returned values will not include quaternions during times when asp_sol_status is non-zero</span>

<span class="sd">    :returns: Nx4 np.array of quaternions, np.array of N times, list of dict with header from each asol file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">revision</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;revision &#39;all&#39; doesn&#39;t really make sense for this function&quot;</span><span class="p">)</span>
    <span class="c1"># These are in time order by default from get_files</span>
    <span class="n">asol_files</span> <span class="o">=</span> <span class="n">get_files</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="n">obsid</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                           <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ASPSOL&#39;</span><span class="p">])</span>
    <span class="n">acal_files</span> <span class="o">=</span> <span class="n">get_files</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="n">obsid</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                           <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ACACAL&#39;</span><span class="p">])</span>
    <span class="n">aqual_files</span> <span class="o">=</span> <span class="n">get_files</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="n">obsid</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                            <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ASPQUAL&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">get_atts_from_files</span><span class="p">(</span><span class="n">asol_files</span><span class="p">,</span> <span class="n">acal_files</span><span class="p">,</span> <span class="n">aqual_files</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_atts_from_files"><a class="viewcode-back" href="../../../api.html#mica.archive.asp_l1.get_atts_from_files">[docs]</a><span class="k">def</span> <span class="nf">get_atts_from_files</span><span class="p">(</span><span class="n">asol_files</span><span class="p">,</span> <span class="n">acal_files</span><span class="p">,</span> <span class="n">aqual_files</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    From ASP1 source files (asol, acal, aqual) get the ground aspect solution quaternions and times covering</span>
<span class="sd">    the range of asol_files in the ACA frame.  The asol, acl, and aqual files are assumed to have one-to-one correspondence</span>
<span class="sd">    (though the asol to acal times are checked).</span>

<span class="sd">    :asol_files: list of aspect asol1 files</span>
<span class="sd">    :acal_files: list of acal1 files associated with asol_files</span>
<span class="sd">    :aqual_files: list of aqual files associated with asol_files</span>
<span class="sd">    :filter: boolean, true means returned values will not include quaternions during times when asp_sol_status is non-zero</span>

<span class="sd">    :returns: Nx4 np.array of quaternions, np.array of N times, list of dict with header from each asol file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># There should be one asol and one acal file for each aspect interval in the range</span>
    <span class="n">att_chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">time_chunks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">asol_f</span><span class="p">,</span> <span class="n">acal_f</span><span class="p">,</span> <span class="n">aqual_f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">asol_files</span><span class="p">,</span> <span class="n">acal_files</span><span class="p">,</span> <span class="n">aqual_files</span><span class="p">):</span>
        <span class="n">asol</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">asol_f</span><span class="p">,</span> <span class="n">hdu</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">acal</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">acal_f</span><span class="p">,</span> <span class="n">hdu</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">aqual</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">aqual_f</span><span class="p">,</span> <span class="n">hdu</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Check that the time ranges match from the fits headers (meta in the table)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">asol</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;TSTART&#39;</span><span class="p">],</span> <span class="n">asol</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;TSTOP&#39;</span><span class="p">]]),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">acal</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;TSTART&#39;</span><span class="p">],</span> <span class="n">acal</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;TSTOP&#39;</span><span class="p">]]),</span>
                           <span class="n">atol</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ACAL and ASOL have mismatched time ranges&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">filter</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">aqual</span><span class="p">[</span><span class="s1">&#39;asp_sol_status&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># For each sample with bad status find the overlapping time range in asol</span>
            <span class="c1"># and remove from set</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">aqual</span><span class="p">[</span><span class="s1">&#39;asp_sol_status&#39;</span><span class="p">]):</span>
                <span class="n">nok</span> <span class="o">=</span> <span class="p">((</span><span class="n">asol</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">aqual</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.025</span><span class="p">))</span>
                       <span class="o">&amp;</span> <span class="p">(</span><span class="n">asol</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">aqual</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.025</span><span class="p">)))</span>
                <span class="n">asol</span> <span class="o">=</span> <span class="n">asol</span><span class="p">[</span><span class="o">~</span><span class="n">nok</span><span class="p">]</span>

        <span class="c1"># Transpose of transform/rotation matrix is the inverse</span>
        <span class="n">aca_mis_inv</span> <span class="o">=</span> <span class="n">acal</span><span class="p">[</span><span class="s1">&#39;aca_misalign&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

        <span class="c1"># Repeat the transform to match asol</span>
        <span class="n">aca_mis_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">aca_mis_inv</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">repeats</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">asol</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">q_mis_inv</span> <span class="o">=</span> <span class="n">Quat</span><span class="p">(</span><span class="n">transform</span><span class="o">=</span><span class="n">aca_mis_inv</span><span class="p">)</span>

        <span class="c1"># Quaternion multiply the asol quats with that inv misalign and save</span>
        <span class="n">q_att_name</span> <span class="o">=</span> <span class="s1">&#39;q_att_raw&#39;</span> <span class="k">if</span> <span class="s1">&#39;q_att_raw&#39;</span> <span class="ow">in</span> <span class="n">asol</span><span class="o">.</span><span class="n">colnames</span> <span class="k">else</span> <span class="s1">&#39;q_att&#39;</span>
        <span class="n">att_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">Quat</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">asol</span><span class="p">[</span><span class="n">q_att_name</span><span class="p">])</span> <span class="o">*</span> <span class="n">q_mis_inv</span><span class="p">)</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>
        <span class="n">time_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">asol</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]))</span>
        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asol</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">att_chunks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_chunks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">att_chunks</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">time_chunks</span><span class="p">),</span> <span class="n">records</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="p">[]</span></div>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the update process to get new ASP L1 telemetry, save it in the Ska</span>
<span class="sd">    file archive, and include it in the file lookup database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">()</span>
    <span class="n">config</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
    <span class="n">archive</span> <span class="o">=</span> <span class="n">obsid_archive</span><span class="o">.</span><span class="n">ObsArchive</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">archive</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">archive</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">())</span>
    <span class="n">obsids</span> <span class="o">=</span> <span class="n">archive</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2012, Jean Connelly.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 6.1.3. &nbsp;
  </p>
</footer>
  </body>
</html>